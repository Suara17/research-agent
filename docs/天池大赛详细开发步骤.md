# 天池 Research Agent 大赛 - 详细开发步骤

## 1. 目录
1. [环境准备](#环境准备)
2. [平台熟悉](#平台熟悉)
3. [下载验证集](#下载验证集)
4. [设计 Agent 架构](#设计-agent-架构)
5. [LangStudio 开发实战](#langstudio-开发实战)
6. [本地测试](#本地测试)
7. [部署到 EAS](#部署到-eas)
8. [提交与验证](#提交与验证)

---

## 2. 环境准备

### 2.1. 注册阿里云账号
- 访问 [阿里云官网](https://www.aliyun.com/) 注册账号
- 完成实名认证（手机号/身份证）

### 2.2. 领取免费资源
1. 访问 [阿里云免费试用中心](https://free.aliyun.com/?productCode=learn)
2. 搜索并领取：
   - **交互式建模 PAI-DSW**
   - **PAI-EAS**（模型服务部署）
3. 注意免费额度和使用期限

### 2.3. 开通 PAI 服务
1. 登录阿里云控制台
2. 搜索「PAI」进入产品页
3. 开通 PAI 服务（部分地区可能需要申请）

---

## 3. 平台熟悉

### 3.1. 访问 PAI-LangStudio
1. 进入 [PAI 控制台](https://pai.console.aliyun.com/)
2. 左侧菜单选择「工作空间」→「应用开发」→「LangStudio」

### 3.2. 了解 LangStudio 两种开发模式

#### 3.2.1. 工作流模式（推荐新手）
- **特点**：可视化拖拽式开发
- **适用场景**：快速原型、流程清晰的任务
- **核心节点**：
  - LLM 节点：调用大模型
  - Python 节点：自定义代码逻辑
  - Tool 节点：调用外部工具（搜索引擎等）

#### 3.2.2. 代码模式
- **特点**：纯代码开发
- **适用场景**：复杂逻辑、需要精细控制
- **语言**：Python

### 3.3. 学习资源
- [PAI-LangStudio 快速入门](https://help.aliyun.com/zh/pai/user-guide/langstudio/)
- [应用流开发指南](https://help.aliyun.com/zh/pai/user-guide/application-flow-development/)

---

## 4. 下载验证集

### 4.1. 下载题目数据
```bash
# 使用浏览器或 curl 下载
curl -O https://pai-quickstart-predeploy-hangzhou.oss-cn-hangzhou.aliyuncs.com/tianchi/question.jsonl
```

### 4.2. 查看数据格式
```jsonl
{"id": 0, "question": "问题1"}
{"id": 1, "question": "问题2"}
```

### 4.3. 分析题目类型
- 事实验证题
- 多步推理题
- 单位换算题
- 信息检索题

---

## 5. 设计 Agent 架构

### 5.1. 推荐 Agent 模式：ReAct

#### 5.1.1. ReAct 工作流程
```
问题 → 思考 → 行动(搜索) → 观察 → 思考 → 行动(再搜索) → ... → 答案
```

#### 5.1.2. 核心组件
1. **思考模块**：分析问题，规划搜索策略
2. **行动模块**：执行搜索、查询等操作
3. **观察模块**：获取搜索结果
4. **记忆模块**：保存中间信息
5. **答案生成**：综合所有信息生成最终答案

### 5.2. 简化版架构（适合初学者）
```
输入问题
  ↓
问题理解（LLM 判断需要搜索什么）
  ↓
搜索工具（调用搜索引擎）
  ↓
结果提取（LLM 从搜索结果中找答案）
  ↓
答案验证（检查答案是否合理）
  ↓
输出答案
```

---

## 6. LangStudio 开发实战

### 6.1. 创建应用

#### 6.1.1. 方法一：工作流模式
1. 进入 LangStudio 页面
2. 点击「新建应用」
3. 选择「从空白创建」或「从模板创建」
4. 命名应用（如 `research-agent`）

#### 6.1.2. 方法二：代码模式
1. 选择「代码模式」
2. 创建新的 Python 项目

### 6.2. 配置模型连接

#### 6.2.1. 连接通义千问模型
1. 在 LangStudio 中进入「连接管理」
2. 点击「新建连接」
3. 选择「阿里云百炼」或「PAI Model Gallery」
4. 配置 API Key 或选择已部署的模型

#### 6.2.2. 推荐模型
- `qwen-turbo`：速度快，成本低
- `qwen-plus`：平衡性能
- `qwen-max`：最强性能（费用较高）

### 6.3. 工作流模式详细步骤

#### 6.3.1. Step 1：创建 LLM 节点（问题理解）
```
节点名称：understand_question
输入：question
模型：qwen-plus
提示词模板：
你是一个问题分析专家。请分析以下问题，判断需要搜索什么信息来回答它。

问题：{{question}}

请输出需要搜索的关键词，用 JSON 格式返回：
{
  "search_query": "搜索关键词",
  "reasoning": "为什么这样搜索"
}
```

#### 6.3.2. Step 2：创建 Tool 节点（搜索引擎）
1. 添加「HTTP 工具」节点
2. 配置搜索引擎 API（推荐使用 SerpAPI 或阿里云 IQS）
3. 输入：上一步输出的 `search_query`
4. 输出：搜索结果列表

**SerpAPI 配置示例：**
```
URL: https://serpapi.com/search
Method: GET
Headers: { "Authorization": "Bearer YOUR_API_KEY" }
Query Params: {
  "q": "{{search_query}}",
  "engine": "google"
}
```

#### 6.3.3. Step 3：创建 LLM 节点（答案提取）
```
节点名称：extract_answer
输入：
  - question（原始问题）
  - search_results（搜索结果）
模型：qwen-plus
提示词模板：
你是一个信息提取专家。请根据搜索结果回答用户的问题。

问题：{{question}}

搜索结果：
{{search_results}}

请直接给出答案，不要添加额外解释。答案要简洁准确。

输出格式（JSON）：
{
  "answer": "你的答案"
}
```

#### 6.3.4. Step 4：创建结束节点
```
节点名称：output
输出：extract_answer.answer
```

#### 6.3.5. Step 5：连接节点
```
开始节点 → understand_question → 搜索工具 → extract_answer → 结束节点
```

### 6.4. 代码模式详细步骤（Python）

#### 6.4.1. 基本结构
```python
from langchain.agents import initialize_agent, Tool
from langchain.llms import Tongyi
from langchain.utilities import SerpAPIWrapper

# 1. 初始化大模型
llm = Tongyi(model="qwen-plus")

# 2. 配置搜索工具
search = SerpAPIWrapper()

# 3. 定义工具列表
tools = [
    Tool(
        name="Search",
        func=search.run,
        description="当需要搜索信息时使用此工具"
    )
]

# 4. 创建 Agent
agent = initialize_agent(
    tools=tools,
    llm=llm,
    agent="zero-shot-react-description",
    verbose=True
)

# 5. 处理问题
def process_question(question):
    answer = agent.run(question)
    return {"answer": answer}
```

#### 6.4.2. 提示词优化
```python
from langchain.prompts import PromptTemplate

# 自定义 Agent 提示词
agent_prompt = PromptTemplate.from_template(
    """你是一个研究助手，擅长通过搜索来回答问题。

问题：{input}

{agent_scratchpad}"""
)

agent.agent.llm_chain.prompt = agent_prompt
```

### 6.5. 调试技巧

#### 6.5.1. 在 LangStudio 中调试
1. 点击节点右侧的「测试」按钮
2. 输入测试数据
3. 查看节点输出结果
4. 根据输出调整提示词或代码

#### 6.5.2. 常见问题排查
- **搜索结果不准确**：优化搜索关键词提取逻辑
- **答案格式错误**：明确要求 JSON 输出格式
- **推理速度慢**：换用更快的模型（qwen-turbo）
- **工具调用失败**：检查 API Key 和网络连接

---

## 7. 本地测试

### 7.1. 下载验证集
```bash
curl -O https://pai-quickstart-predeploy-hangzhou.oss-cn-hangzhou.aliyuncs.com/tianchi/question.jsonl
```

### 7.2. 创建测试脚本
```python
import json

# 读取验证集
with open('question.jsonl', 'r', encoding='utf-8') as f:
    questions = [json.loads(line) for line in f]

# 处理每个问题
results = []
for q in questions:
    answer = process_question(q['question'])
    results.append({
        "id": q['id'],
        "answer": answer['answer']
    })

# 保存结果
with open('submission.jsonl', 'w', encoding='utf-8') as f:
    for r in results:
        f.write(json.dumps(r, ensure_ascii=False) + '\n')
```

### 7.3. 计算正确率
```python
# 如果你有参考答案（实际比赛中没有）
with open('ground_truth.jsonl', 'r') as f:
    ground_truth = [json.loads(line) for line in f]

correct = 0
for pred, truth in zip(results, ground_truth):
    if pred['answer'].strip().lower() == truth['answer'].strip().lower():
        correct += 1

accuracy = correct / len(results)
print(f"正确率: {accuracy * 100:.2f}%")
```

---

## 8. 部署到 EAS

### 8.1. 导出应用流
1. 在 LangStudio 中点击「导出」
2. 选择「导出为应用流 ZIP」
3. 下载 ZIP 文件

### 8.2. 部署到 EAS

#### 8.2.1. 方法一：通过 LangStudio 一键部署
1. 在应用页面点击「部署」
2. 选择「部署到 EAS」
3. 配置服务参数：
   - **服务名称**：research-agent-service
   - **实例规格**：2C4G（可后续调整）
   - **实例数量**：1
4. 点击「部署」
5. 等待部署完成（约 3-5 分钟）

#### 8.2.2. 方法二：手动部署
1. 进入 [EAS 控制台](https://eas.console.aliyun.com/)
2. 点击「部署服务」
3. 上传 LangStudio 导出的 ZIP 文件
4. 配置服务参数
5. 启动服务

### 8.3. 获取服务信息
部署成功后，记录以下信息：
- **Endpoint**：服务访问地址
- **Token**：认证令牌

### 8.4. 测试 EAS 服务
```bash
curl -X POST \
  -H "Authorization: Bearer <your_token>" \
  -H "Content-Type: application/json" \
  -H "Accept: text/event-stream" \
  -d '{"question": "Where is the capital of France?"}' \
  "<your_endpoint>"
```

预期响应：
```json
{
  "answer": "巴黎"
}
```

---

## 9. 提交与验证

### 9.1. 阶段一提交

#### 9.1.1. 提交内容
1. **验证集答案文件**（submission.jsonl）

#### 9.1.2. 文件格式
```jsonl
{"id": 0, "answer": "答案1"}
{"id": 1, "answer": "答案2"}
```

#### 9.1.3. 提交步骤
1. 登录天池大赛页面
2. 进入「提交结果」
3. 上传 JSONL 文件
4. 查看评测结果和排名

#### 9.1.4. 注意事项
- 确保答案格式正确
- 所有题目都要有答案
- 不要遗漏任何题目

### 9.2. 阶段二提交（进入前60%后）

#### 9.2.1. 提交内容
1. **EAS 服务信息**：
   - Endpoint
   - Token

2. **LangStudio 项目包**（ZIP 文件）

3. **README 文档**（包含在 ZIP 包内）

#### 9.2.2. README 模板
```markdown
# Research Agent 项目文档

## 项目概述
[简要描述你的 Agent 设计思路]

## 架构说明
[描述整体架构和各组件功能]

## 复现步骤
1. 上传 ZIP 到 LangStudio
2. 选择「从 OSS 创建」
3. 配置模型连接
4. 测试并部署

## 技术栈
- LangStudio 工作流模式
- Qwen-Plus 模型
- SerpAPI 搜索工具

## 参考资料
[列出参考的开源项目或论文]
```

### 9.3. 验证部署一致性
在提交前，务必验证：
1. 从 ZIP 包重新创建应用流
2. 测试新创建的应用流
3. 部署新应用流到 EAS
4. 确保 EAS 服务与 ZIP 包一致

### 9.4. 评测流程
- 主办方在 3 月 9-13 日随机调用你的服务
- 每个问题超时 30 分钟
- 只有一次测试机会
- 服务异常 = 零分

---

## 10. 进阶优化建议

### 10.1. 提示词优化
- 使用少样本学习（Few-shot）
- 添加思维链（Chain of Thought）
- 明确输出格式要求

### 10.2. 工具优化
- 尝试多个搜索引擎
- 实现搜索结果去重
- 添加信息可信度评估

### 10.3. 架构优化
- 增加多轮搜索策略
- 实现答案交叉验证
- 添加记忆模块

---

## 11. 常见问题 FAQ

### 11.1. Q1: 如何获取搜索引擎 API？
**A**: 推荐 SerpAPI，有免费额度。或使用阿里云 IQS。

### 11.2. Q2: 模型调用失败怎么办？
**A**: 检查 API Key 是否正确，账户余额是否充足。

### 11.3. Q3: 答案格式错误？
**A**: 确保严格按 JSON 格式输出，不要有多余内容。

### 11.4. Q4: 超时怎么办？
**A**: 优化搜索策略，减少不必要的工具调用，换用更快的模型。

### 11.5. Q5: 如何提高正确率？
**A**: 
- 优化提示词
- 增加多轮搜索
- 交叉验证答案

---

## 12. 时间节点

| 时间 | 事项 |
|------|------|
| ~2月2日 | Agent 赛道重新开放 |
| 3月9日 | 阶段一提交截止 |
| 3月9-13日 | 阶段二评测 |
| 3月13日 | 最终结果公布 |

---

## 13. 联系与支持
- [PAI-LangStudio 文档](https://help.aliyun.com/zh/pai/user-guide/langstudio/)
- [天池大赛官网](https://tianchi.aliyun.com/)
- 阿里云技术支持：400-801-3260

祝比赛顺利！🎉