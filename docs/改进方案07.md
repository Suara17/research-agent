è¿™æ˜¯ä¸€ä¸ªéå¸¸æ·±å…¥ä¸”å…·æœ‰æ¶æ„æ„ä¹‰çš„é—®é¢˜ã€‚è¦å°†â€œè§„åˆ’å™¨ (Planner)â€å¼ºåˆ¶åµŒå…¥åˆ° Agent é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè§£æ„ç°æœ‰çš„ä»£ç æµç¨‹ï¼Œç„¶ååœ¨ä¸€ä¸ªç²¾å‡†çš„â€œåˆ‡å…¥ç‚¹â€æ’å…¥è§„åˆ’é€»è¾‘ï¼Œä½¿å…¶æˆä¸ºæ•´ä¸ªæ€è€ƒé“¾æ¡çš„**å‰ç½®å®ˆé—¨å‘˜**ã€‚

### ç¬¬ä¸€æ­¥ï¼šæ·±åº¦è§£æ„ç°æœ‰æ¶æ„

åŸºäºä½ ä¸Šä¼ çš„ `agent.py` å’Œ `agent_loop.py`ï¼Œç°æœ‰çš„å·¥ä½œæµæ˜¯å…¸å‹çš„ **ReAct (Reason + Act)** æ¨¡å¼ï¼Œç¼ºä¹å…¨å±€è§†è§’çš„â€œæ·±æ€ç†Ÿè™‘â€ã€‚

#### 1. `agent.py` (å…¥å£å±‚)

* **èŒè´£**ï¼šå®ƒæ˜¯ API æ¥å£å±‚ï¼ˆFastAPIï¼‰ã€‚æ¥æ”¶ç”¨æˆ·è¯·æ±‚ `req.question`ï¼Œå°†å†å²è®°å½•è½¬åŒ–ä¸º `messages` åˆ—è¡¨ï¼Œç„¶åç›´æ¥ä¸¢ç»™ `agent_loop`ã€‚
* **å±€é™**ï¼šå®ƒåªæ˜¯ä¸€ä¸ªâ€œä¼ å£°ç­’â€ï¼Œæ²¡æœ‰å¯¹é—®é¢˜è¿›è¡Œé¢„å¤„ç†æˆ–æ‹†è§£ã€‚

#### 2. `agent_loop.py` (æ ¸å¿ƒå¤§è„‘)

* **èŒè´£**ï¼šåŸºäº `langgraph` æ„å»ºäº†ä¸€ä¸ªçŠ¶æ€æœºå¾ªç¯ã€‚
* **ç°æœ‰çŠ¶æ€å›¾ (StateGraph)**ï¼š
```text
[__start__] -> [llm_step] <--> [execute_tools]
                   |
                   v
             [update_memory] -> [persist_state] -> [END]

```


* **æ ¸å¿ƒé€»è¾‘ (`llm_step`)**ï¼šç›´æ¥è°ƒç”¨ LLMï¼Œè®© LLM è‡ªå·±å†³å®šæ˜¯è¯´è¯è¿˜æ˜¯è°ƒç”¨å·¥å…·ï¼ˆSearch/Fetchï¼‰ã€‚
* **ç—›ç‚¹**ï¼šLLM ä¸€ä¸Šæ¥å°±é¢å¯¹å…·ä½“å·¥å…·ï¼ˆSearchï¼‰ï¼Œå€¾å‘äºç›´æ¥åŠ¨æ‰‹æœç´¢ï¼Œè€Œä¸æ˜¯å…ˆæ€è€ƒç­–ç•¥ã€‚å¯¹äºâ€œè°œé¢˜å‹â€å¤æ‚é—®é¢˜ï¼Œè¿™ä¼šå¯¼è‡´ç¬¬ä¸€æ­¥æœç´¢å¾€å¾€æ˜¯ä½è´¨é‡çš„â€œç›´çƒæœç´¢â€ã€‚

---

### ç¬¬äºŒæ­¥ï¼šè§„åˆ’å™¨ (Planner) åµŒå…¥æ–¹æ¡ˆ

ä¸ºäº†â€œå¼ºåˆ¶â€æ‰€æœ‰é—®é¢˜å…ˆè§„åˆ’ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä¾èµ– LLM çš„è‡ªè§‰æ€§ï¼ˆPrompt å·¥ç¨‹ï¼‰ï¼Œè€Œåº”è¯¥åœ¨**ä»£ç ç»“æ„**ä¸Šå¼ºåˆ¶æ‰§è¡Œã€‚

æˆ‘å»ºè®®é‡‡ç”¨ **â€œç‹¬ç«‹è§„åˆ’èŠ‚ç‚¹ (Explicit Planner Node)â€** æ–¹æ¡ˆã€‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `agent_loop.py`ï¼Œåœ¨ `StateGraph` çš„ `__start__` å’Œ `llm_step` ä¹‹é—´æ’å…¥ä¸€ä¸ªå…¨æ–°çš„èŠ‚ç‚¹ `planner_step`ã€‚

#### ä¿®æ”¹åçš„çŠ¶æ€å›¾æ¶æ„ï¼š

```text
[__start__] 
     |
     v
[planner_step] (æ–°èŠ‚ç‚¹: å¼ºåˆ¶ç”Ÿæˆ Plan)
     |
     v
[llm_step] (åŸèŠ‚ç‚¹: åŸºäº Plan æ‰§è¡Œ) <--> [execute_tools]
     |
     v
    ...

```

---

### ç¬¬ä¸‰æ­¥ï¼šä»£ç å®ç°æŒ‡å—

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹ `agent_loop.py`ã€‚

#### 1. å®šä¹‰ Planner Prompt å’ŒèŠ‚ç‚¹å‡½æ•°

åœ¨ `agent_loop.py` ä¸­ï¼ˆå»ºè®®åœ¨ `agent_loop` å‡½æ•°å†…éƒ¨ï¼Œ`llm_step` å®šä¹‰ä¹‹å‰ï¼‰ï¼Œæ–°å¢ `planner_step` å‡½æ•°ã€‚

```python
    # === æ–°å¢ï¼šPlanner ä¸“ç”¨ Prompt ===
    PLANNER_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªé«˜é˜¶æ€ç»´çš„è§„åˆ’ä¸“å®¶ (Planner)ã€‚
ä½ çš„ç›®æ ‡ä¸æ˜¯å›ç­”é—®é¢˜ï¼Œè€Œæ˜¯å°†ç”¨æˆ·å¤æ‚çš„è¯·æ±‚æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„ã€é€æ­¥çš„è¡ŒåŠ¨è®¡åˆ’ (Plan)ã€‚

### è§„åˆ’åŸåˆ™
1. **è¯†åˆ«æ ¸å¿ƒéš¾ç‚¹**ï¼šæŒ‡å‡ºé—®é¢˜ä¸­çš„â€œè°œé¢˜â€ã€â€œé™·é˜±â€æˆ–â€œæ¨¡ç³Šå®ä½“â€ï¼ˆå¦‚â€œæœ¬åä¸åŠŸç‡å•ä½ç›¸åŒâ€ï¼‰ã€‚
2. **æ‹†è§£æ­¥éª¤**ï¼š
   - å¯¹äºä¿¡æ¯æ£€ç´¢ç±»ï¼šå…ˆå®šä¹‰æœç´¢å…³é”®è¯ï¼ˆKeywordsï¼‰ï¼Œå†å®šä¹‰éªŒè¯é€»è¾‘ã€‚
   - å¯¹äºè°œé¢˜ç±»ï¼šå…ˆç©·ä¸¾å€™é€‰é›†åˆï¼ˆå¦‚â€œæ‰€æœ‰åŠŸç‡å•ä½â€ï¼‰ï¼Œå†è¿›è¡Œäº¤å‰éªŒè¯ã€‚
   - å¯¹äºä¸­æ–‡é—®é¢˜ï¼šæ˜ç¡®æŒ‡å‡ºéœ€è¦ä½¿ç”¨ä¸­æ–‡æºï¼ˆBaidu/WeChatï¼‰è¿˜æ˜¯è‹±æ–‡æºã€‚
3. **å¼ºåˆ¶è¾“å‡ºæ ¼å¼**ï¼š
   Plan:
   1. [æœç´¢/Search] ...
   2. [åˆ†æ/Analyze] ...
   3. [éªŒè¯/Verify] ...
   
æ³¨æ„ï¼šä¿æŒç®€ç»ƒï¼Œä¸è¦è¿›è¡Œå®é™…æœç´¢ï¼Œåªç”Ÿæˆè®¡åˆ’ã€‚
"""

    # === æ–°å¢ï¼šPlanner èŠ‚ç‚¹å‡½æ•° ===
    def planner_step(state: dict) -> dict:
        # 1. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ Plan äº†ï¼ˆé¿å…å¾ªç¯ä¸­é‡å¤è§„åˆ’ï¼‰
        # å¦‚æœæ˜¯ç¬¬ä¸€æ­¥ (step_index == 0)ï¼Œåˆ™å¼ºåˆ¶è§„åˆ’
        if state["step_index"] > 0:
            return state

        messages = state["messages"]
        user_query = ""
        # æå–ç”¨æˆ·æœ€æ–°é—®é¢˜
        for m in reversed(messages):
            if m["role"] == "user":
                user_query = m["content"]
                break
        
        print(f"[Planner] æ­£åœ¨ä¸ºé—®é¢˜åˆ¶å®šè®¡åˆ’: {user_query[:50]}...")

        # 2. è°ƒç”¨ LLM ç”Ÿæˆè®¡åˆ’ (ä½¿ç”¨è½»é‡çº§é…ç½®ï¼Œä¸å¸¦ Tools)
        planner_messages = [
            {"role": "system", "content": PLANNER_SYSTEM_PROMPT},
            {"role": "user", "content": f"è¯·ä¸ºè¿™ä¸ªé—®é¢˜åˆ¶å®šè°ƒç ”è®¡åˆ’ï¼š{user_query}"}
        ]
        
        try:
            resp = client.chat.completions.create(
                model="qwen3-max", # æˆ–ä½¿ç”¨æ›´å¼ºçš„æ¨ç†æ¨¡å‹
                messages=planner_messages,
                temperature=0.7, # ç¨å¾®é«˜ä¸€ç‚¹çš„åˆ›é€ æ€§
                max_tokens=512
            )
            plan_content = resp.choices[0].message.content
            
            # 3. å°†è®¡åˆ’æ³¨å…¥åˆ°å¯¹è¯å†å²ä¸­ï¼Œä½œä¸º System æŒ‡ä»¤æˆ– Assistant çš„è‡ªæˆ‘æ€è€ƒ
            # æŠ€å·§ï¼šä¼ªé€ ä¸€æ¡ Assistant çš„â€œæ€è€ƒâ€è®°å½•ï¼Œè®© LLM è§‰å¾—è¿™æ˜¯å®ƒè‡ªå·±åˆšæ‰æƒ³å‡ºæ¥çš„
            plan_injection = f"ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åˆ¶å®šäº†ä»¥ä¸‹è®¡åˆ’ï¼š\n\n{plan_content}\n\nç°åœ¨æˆ‘å°†å¼€å§‹æ‰§è¡Œç¬¬ä¸€æ­¥ã€‚"
            
            # å°† Plan æ’å…¥åˆ° messages åˆ—è¡¨ä¸­ï¼ˆåœ¨ System Prompt ä¹‹åï¼ŒUser ä¹‹å‰ï¼Œæˆ–è€…ä½œä¸º User ä¹‹åçš„ Assistant é“ºå«ï¼‰
            # æœ€ç¨³å¦¥çš„æ–¹å¼ï¼šä½œä¸ºä¸€æ¡ System Context æ’å…¥åˆ°é˜Ÿå°¾ï¼Œå¼ºæé†’
            new_messages = messages.copy()
            new_messages.append({"role": "assistant", "content": plan_injection})
            
            print(f"[Planner] è®¡åˆ’ç”Ÿæˆå®Œæ¯•:\n{plan_content}")
            
            return {
                **state,
                "messages": new_messages,
                # å¯ä»¥åœ¨ meta ä¸­æ ‡è®°å·²è§„åˆ’
                "meta": {**state.get("meta", {}), "has_plan": True}
            }
            
        except Exception as e:
            print(f"[Planner] è§„åˆ’å¤±è´¥: {e}")
            return state

```

#### 2. å°†èŠ‚ç‚¹æ³¨å†Œåˆ° LangGraph

æ‰¾åˆ° `agent_loop.py` åº•éƒ¨æ„å»º `StateGraph` çš„éƒ¨åˆ†ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

```python
    # ... åŸæœ‰ä»£ç  ...
    g = StateGraph(dict)
    
    # 1. æ³¨å†Œæ–°èŠ‚ç‚¹
    g.add_node("planner_step", planner_step)  # <--- æ–°å¢
    g.add_node("llm_step", llm_step)
    g.add_node("execute_tools", execute_tools)
    g.add_node("update_memory", update_memory)
    g.add_node("persist_state", persist_state)

    # 2. ä¿®æ”¹è¿çº¿é€»è¾‘ (å…³é”®!)
    # åŸæ¥: g.add_edge("__start__", "llm_step")
    
    # ä¿®æ”¹å: Start -> Planner -> LLM
    g.add_edge("__start__", "planner_step")      # <--- å¿…é¡»å…ˆèµ° Planner
    g.add_edge("planner_step", "llm_step")       # <--- Planner å®Œäº‹åç»™ LLM æ‰§è¡Œ
    
    g.add_edge("llm_step", "execute_tools")
    g.add_edge("execute_tools", "update_memory")
    g.add_edge("update_memory", "persist_state")
    
    # æ³¨æ„ï¼špersist_state ä¹‹åé€šå¸¸æ˜¯æŒ‡å‘ END è¿˜æ˜¯å¾ªç¯å› llm_step?
    # ä½ çš„åŸä»£ç é€»è¾‘æ˜¯å•æ¬¡å¾ªç¯é  while æ§åˆ¶ invokeï¼Œè¿˜æ˜¯ graph å†…éƒ¨å¾ªç¯ï¼Ÿ
    # ç»æ£€æŸ¥åŸä»£ç ï¼šstate = graph.invoke(state) æ˜¯åœ¨ while å¾ªç¯é‡Œè°ƒç”¨çš„ã€‚
    # è¿™æ„å‘³ç€ LangGraph åœ¨è¿™é‡Œè¢«å½“åšå•æ­¥æ‰§è¡Œå™¨ä½¿ç”¨ã€‚
    # å¦‚æœæ˜¯è¿™æ ·ï¼Œplanner_step åªéœ€è¦åœ¨ step_index == 0 æ—¶ç”Ÿæ•ˆå³å¯ã€‚
    
    g.add_edge("persist_state", END)
    graph = g.compile()

```

### âš ï¸ é‡è¦ä¿®æ­£ï¼šé’ˆå¯¹ `while` å¾ªç¯çš„é€‚é…

æˆ‘çœ‹äº†ä¸€ä¸‹ä½ çš„ `agent_loop` æ˜¯åœ¨ä¸€ä¸ª `while` å¾ªç¯ä¸­åå¤è°ƒç”¨ `graph.invoke(state)`ã€‚
è¿™æ„å‘³ç€æ¯æ¬¡å¾ªç¯éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ Graph æ‰§è¡Œã€‚

**ä¿®æ­£é€»è¾‘ï¼š**
æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°åœ¨ Graph é‡ŒåŠ èŠ‚ç‚¹ï¼Œå› ä¸º `planner_step` åªéœ€è¦æ‰§è¡Œ**ä¸€æ¬¡**ï¼ˆåœ¨æœ€å¼€å§‹ï¼‰ã€‚å¦‚æœåœ¨ Graph é‡ŒåŠ ï¼Œæ¯æ¬¡ while å¾ªç¯éƒ½ä¼šè·‘ä¸€æ¬¡ Plannerï¼Œè¿™å¾ˆæµªè´¹ä¸”ç”šè‡³ä¼šæ­»å¾ªç¯ã€‚

**æ›´ä¼˜æ–¹æ¡ˆï¼šåœ¨ `while` å¾ªç¯å¤–æ‰§è¡Œ Planner**

ç›´æ¥åœ¨ `agent_loop` å‡½æ•°çš„ `while state["step_index"] < max_steps:` å¾ªç¯**ä¹‹å‰**ï¼Œæ’å…¥ Planner é€»è¾‘ã€‚

**ä¿®æ”¹åçš„ `agent_loop` ç»“æ„ (`agent_loop.py`):**

```python
async def agent_loop(...):
    # ... (åˆå§‹åŒ– client, memory, skills ç­‰) ...

    # === [æ’å…¥ç‚¹] ===
    # åœ¨è¿›å…¥ while å¾ªç¯ä¹‹å‰ï¼Œå…ˆè¿›è¡Œä¸€æ¬¡å…¨å±€è§„åˆ’
    
    # 1. æå–ç”¨æˆ·é—®é¢˜
    user_query = ""
    for m in reversed(prompt_messages):
        if m.get("role") == "user":
            user_query = m.get("content")
            break
            
    # 2. åªæœ‰å¤æ‚é—®é¢˜æ‰è§„åˆ’ (å¯é€‰ï¼Œæˆ–è€…å¼ºåˆ¶æ‰€æœ‰)
    if len(user_query) > 10: 
        print(f"--- [Planner] Start Planning for: {user_query[:30]}... ---")
        planner_prompt = [
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªè§„åˆ’ä¸“å®¶ã€‚è¯·é’ˆå¯¹ç”¨æˆ·é—®é¢˜ï¼Œåˆ¶å®šä¸€ä¸ªç®€æ˜æ‰¼è¦çš„ 3-5 æ­¥æœç´¢ä¸æ¨ç†è®¡åˆ’ã€‚ç›´æ¥è¾“å‡ºè®¡åˆ’å†…å®¹ã€‚"},
            {"role": "user", "content": user_query}
        ]
        try:
            # è¿™é‡Œçš„ client å¤ç”¨ä¹‹å‰çš„å®šä¹‰
            plan_resp = client.chat.completions.create(
                model="qwen3-max", 
                messages=planner_prompt,
                temperature=0.5
            )
            plan = plan_resp.choices[0].message.content
            
            # 3. å°† Plan å¼ºè¡Œå¡å…¥ system prompt æˆ–å†å²è®°å½•
            # è¿™æ ·åç»­çš„ llm_step å°±ä¼šçœ‹åˆ°è¿™ä¸ªè®¡åˆ’å¹¶å°è¯•å»æ‰§è¡Œ
            system_prompt_addition += f"\n\n### ğŸ“‹ CURRENT PLAN (Follow this strictly)\n{plan}\n\nExecute step 1 now."
            
            # åŒæ—¶æ›´æ–° prompt_messages ä¸­çš„ system prompt
            if prompt_messages[0].get("role") == "system":
                prompt_messages[0]["content"] += f"\n\n### ğŸ“‹ CURRENT PLAN\n{plan}"
                
            print(f"--- [Planner] Plan Generated ---\n{plan}\n--------------------------------")
        except Exception as e:
            print(f"[Planner Error] {e}")

    # ... (ç»§ç»­åŸæœ‰çš„ StateGraph åˆå§‹åŒ–) ...
    
    g = StateGraph(dict)
    # ... (Graph å®šä¹‰ä¸éœ€è¦å˜ï¼Œå› ä¸º Planner å·²ç»åœ¨å¾ªç¯å¤–åšå®Œäº†) ...
    
    while state["step_index"] < max_steps:
        # LLM ç°åœ¨å¸¦ç€ Plan çš„è®°å¿†å¼€å§‹å·¥ä½œäº†
        state = graph.invoke(state)
        # ...

```

### æ€»ç»“

æ–¹æ¡ˆ **â€œåœ¨ while å¾ªç¯å¤–é¢„çƒ­â€** æ˜¯æ”¹åŠ¨æœ€å°ã€é£é™©æœ€ä½ä¸”å®Œå…¨ç¬¦åˆä½ ç°æœ‰é“¾è·¯çš„æ–¹æ¡ˆã€‚

1. **ä½ç½®**ï¼š`agent_loop.py` ä¸­ï¼Œåœ¨ `client = OpenAI(...)` ä¹‹åï¼Œ`g = StateGraph(dict)` ä¹‹å‰ã€‚
2. **åŠ¨ä½œ**ï¼šè°ƒç”¨ä¸€æ¬¡ LLM ç”Ÿæˆ Planã€‚
3. **èåˆ**ï¼šå°†ç”Ÿæˆçš„ Plan å­—ç¬¦ä¸² append åˆ° `system_prompt_addition` å˜é‡ä¸­ã€‚è¿™æ ·ï¼Œåç»­çš„ `llm_step` æ— è®ºæ€ä¹ˆè·‘ï¼Œè„‘å­é‡Œéƒ½æœ‰è¿™ä¸ªâ€œä½œæˆ˜åœ°å›¾â€ã€‚
4. **æ•ˆæœ**ï¼šAgent çœ‹åˆ° Prompt é‡Œæœ‰ "Current Plan: 1. Search xxx", å®ƒå°±ä¼šå€¾å‘äºè¾“å‡º "Action: web_search {'query': 'xxx'}"ï¼Œä»è€Œè§£å†³äº†ä¹±æœç´¢çš„é—®é¢˜ã€‚