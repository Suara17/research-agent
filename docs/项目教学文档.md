# Research Agent é¡¹ç›®æ•™å­¦æ–‡æ¡£

> æœ¬æ–‡æ¡£ä¸ºå­¦ä¹  Research Agent é¡¹ç›®æä¾›è¯¦ç»†çš„ä»£ç è®²è§£å’ŒæŠ€æœ¯è¯´æ˜

---

## ğŸ“š ç›®å½•

1. [åŸºç¡€é—®é¢˜](#åŸºç¡€é—®é¢˜)
   - [Q1: Agent çš„æ ¸å¿ƒå…¥å£æ˜¯ä»€ä¹ˆï¼Ÿ](#q1-agent-çš„æ ¸å¿ƒå…¥å£æ˜¯ä»€ä¹ˆ)
   - [Q2: è¿™ä¸ªé¡¹ç›®ä½¿ç”¨äº†å“ªä¸ª LLM æ¨¡å‹ï¼Ÿ](#q2-è¿™ä¸ªé¡¹ç›®ä½¿ç”¨äº†å“ªä¸ª-llm-æ¨¡å‹)
   - [Q3: ç”¨æˆ·å‘é€ä¸€ä¸ªé—®é¢˜åï¼Œæ•°æ®æµç»å†äº†å“ªäº›æ­¥éª¤ï¼Ÿ](#q3-ç”¨æˆ·å‘é€ä¸€ä¸ªé—®é¢˜åæ•°æ®æµç»å†äº†å“ªäº›æ­¥éª¤)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
   - [ReAct æ¨¡å¼](#react-æ¨¡å¼)
   - [Function Callingï¼ˆå·¥å…·è°ƒç”¨ï¼‰](#function-callingså·¥å…·è°ƒç”¨)
   - [Agent Skills ç³»ç»Ÿ](#agent-skills-ç³»ç»Ÿ)
3. [FastAPI æ¡†æ¶](#fastapi-æ¡†æ¶)
   - [ä»€ä¹ˆæ˜¯ FastAPIï¼Ÿ](#ä»€ä¹ˆæ˜¯-fastapi)
   - [FastAPI åœ¨æœ¬é¡¹ç›®ä¸­çš„ä½¿ç”¨](#fastapi-åœ¨æœ¬é¡¹ç›®ä¸­çš„ä½¿ç”¨)
   - [FastAPI çš„è‡ªåŠ¨æ–‡æ¡£åŠŸèƒ½](#fastapi-çš„è‡ªåŠ¨æ–‡æ¡£åŠŸèƒ½)

---

## åŸºç¡€é—®é¢˜

### Q1: Agent çš„æ ¸å¿ƒå…¥å£æ˜¯ä»€ä¹ˆï¼Ÿ

#### ç­”æ¡ˆï¼š`agent.py`

`agent.py` æ˜¯æ•´ä¸ªé¡¹ç›®çš„**å…¥å£æ–‡ä»¶**ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåŸºäº **FastAPI** çš„ Web æœåŠ¡ã€‚

#### ä¸ºä»€ä¹ˆæ˜¯ `agent.py`ï¼Ÿ

æŸ¥çœ‹ `agent.py` çš„å¼€å¤´éƒ¨åˆ†ï¼š

```python
from fastapi import FastAPI

app = FastAPI()  # â† è¿™æ˜¯ FastAPI åº”ç”¨å®ä¾‹
```

è¿™ä¸ª `app` å¯¹è±¡éå¸¸é‡è¦ï¼Œå› ä¸ºï¼š
- å¹³å°ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åŠ è½½ `agent.py` ä¸­çš„ `app` å¯¹è±¡æ¥å¯åŠ¨æœåŠ¡
- å®ƒå®šä¹‰äº†æ‰€æœ‰çš„ API ç«¯ç‚¹ï¼ˆendpointsï¼‰

#### æä¾›äº†å“ªäº› API æ¥å£ï¼Ÿ

`agent.py` å®šä¹‰äº†ä¸‰ä¸ªä¸»è¦æ¥å£ï¼š

| æ¥å£ | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| æ™®é€šè¯·æ±‚ | `POST /` | è¿”å›å®Œæ•´çš„ç­”æ¡ˆ |
| æµå¼è¯·æ±‚ | `POST /stream` | å®æ—¶æµå¼è¿”å›ç­”æ¡ˆç‰‡æ®µ |
| AG-UI åè®® | `POST /ag-ui` | ç”¨äº LangStudio è°ƒè¯•é¢æ¿ |

#### å¦‚ä½•å¯åŠ¨æœåŠ¡ï¼Ÿ

```bash
python agent.py
```

å¯åŠ¨åï¼ŒæœåŠ¡é»˜è®¤è¿è¡Œåœ¨ `http://localhost:8000`

#### å¦‚ä½•è°ƒç”¨æ¥å£ï¼Ÿ

**æ™®é€šè¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl -X POST "http://localhost:8000/" \
  -H "Content-Type: application/json" \
  -d '{"question": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}'
```

**å“åº”**ï¼š
```json
{
  "answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"
}
```

---

### Q2: è¿™ä¸ªé¡¹ç›®ä½¿ç”¨äº†å“ªä¸ª LLM æ¨¡å‹ï¼Ÿ

#### ç­”æ¡ˆï¼šé˜¿é‡Œäº‘ç™¾ç‚¼çš„ **Qwen æ¨¡å‹**

#### é…ç½®ä½ç½®

æŸ¥çœ‹ `agent_loop.py:115-133`ï¼š

```python
client = AsyncOpenAI(
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",  # â† é˜¿é‡Œäº‘ç™¾ç‚¼
    api_key=os.getenv("DASHSCOPE_API_KEY"),  # â† éœ€è¦é…ç½®ç¯å¢ƒå˜é‡
)

params = {
    "model": "qwen-plus",  # â† ä½¿ç”¨çš„æ¨¡å‹
    "stream": True,
}
```

#### ä¸ºä»€ä¹ˆé€‰æ‹©é˜¿é‡Œäº‘ç™¾ç‚¼ï¼Ÿ

æ ¹æ® `DEVELOPMENT_GUIDE.md` çš„**æ ¸å¿ƒå¼€å‘è§„èŒƒï¼ˆçº¢çº¿ï¼‰**ï¼š

> **æŒ‡å®šæ¨¡å‹èŒƒå›´**ï¼šä»…å…è®¸ä½¿ç”¨é€šè¿‡ **é˜¿é‡Œäº‘ç™¾ç‚¼** æä¾›çš„ Qwen ç³»åˆ—æ¨¡å‹æˆ– PAI Model Gallery éƒ¨ç½²çš„ Qwen åŸºç¡€æ¨¡å‹ã€‚

è¿™æ˜¯**å¤©æ± å¤§èµ›çš„å¼ºåˆ¶è¦æ±‚**ï¼Œå‚èµ›è€…å¿…é¡»ä½¿ç”¨é˜¿é‡Œäº‘æä¾›çš„æ¨¡å‹ã€‚

#### ä½¿ç”¨çš„æ¨¡å‹å‹å·

å½“å‰ä½¿ç”¨çš„æ˜¯ `qwen-plus`ï¼š

| æ¨¡å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `qwen-plus` | å¹³è¡¡æ€§èƒ½ä¸é€Ÿåº¦ | é€šç”¨åœºæ™¯ï¼Œæˆæœ¬é€‚ä¸­ |
| `qwen-max` | æœ€å¼ºæ¨ç†èƒ½åŠ› | å¤æ‚é—®é¢˜ï¼Œéœ€è¦é«˜è´¨é‡ç­”æ¡ˆ |
| `qwen-turbo` | é€Ÿåº¦å¿«ï¼Œæˆæœ¬ä½ | ç®€å•é—®ç­”ï¼Œé«˜å¹¶å‘åœºæ™¯ |

#### å¦‚ä½•é…ç½® API Keyï¼Ÿ

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
DASHSCOPE_API_KEY=your_api_key_here
```

æˆ–è€…åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```bash
export DASHSCOPE_API_KEY=your_api_key_here
```

---

### Q3: ç”¨æˆ·å‘é€ä¸€ä¸ªé—®é¢˜åï¼Œæ•°æ®æµç»å†äº†å“ªäº›æ­¥éª¤ï¼Ÿ

#### å®Œæ•´æ•°æ®æµç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å‘é€è¯·æ±‚                                  â”‚
â”‚  {"question": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: FastAPI æ¥æ”¶è¯·æ±‚ (agent.py)                             â”‚
â”‚  - è·¯ç”±: @app.post("/")                                         â”‚
â”‚  - æ¥æ”¶: QueryRequest(question="åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ")            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: æ„å»ºæ¶ˆæ¯åˆ—è¡¨ (agent.py:98-105)                          â”‚
â”‚  - è°ƒç”¨ req.to_messages() è½¬æ¢ä¸º OpenAI æ ¼å¼ï¼š                   â”‚
â”‚  [                                                                â”‚
â”‚    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ª Research Agent..."},  â”‚
â”‚    {"role": "user", "content": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}           â”‚
â”‚  ]                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: è¿›å…¥ Agent Loop (agent_loop.py)                          â”‚
â”‚  - ä¼ å…¥: messages, tool_functions=[web_search, get_weather]      â”‚
â”‚  - å¼‚æ­¥ç”Ÿæˆå™¨: async for chunk in agent_loop(...)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: ç¬¬ä¸€è½®å¾ªç¯ - LLM æ€è€ƒ                                    â”‚
â”‚  - è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼ API                                             â”‚
â”‚  - LLM è¿”å›: éœ€è¦è°ƒç”¨ get_weather å·¥å…·                            â”‚
â”‚  - yield: Chunk(type="tool_call", tool_name="get_weather")       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ‰§è¡Œå·¥å…· (agent_loop.py:258-290)                        â”‚
â”‚  - æŸ¥æ‰¾å‡½æ•°: tool_functions_map["get_weather"]                    â”‚
â”‚  - æ‰§è¡Œ: result = get_weather(location="åŒ—äº¬")                   â”‚
â”‚  - è¿”å›: "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸© 10-20â„ƒ"                              â”‚
â”‚  - yield: Chunk(type="tool_call_result", tool_result=...)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: ç¬¬äºŒè½®å¾ªç¯ - LLM åŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ                 â”‚
â”‚  - å°†å·¥å…·ç»“æœæ·»åŠ åˆ°æ¶ˆæ¯å†å²                                         â”‚
â”‚  - å†æ¬¡è°ƒç”¨ LLM                                                   â”‚
â”‚  - LLM è¿”å›: "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"         â”‚
â”‚  - yield: Chunk(type="text", content="åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—...")      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 7: è¿‡æ»¤å¹¶ç»„è£…ç­”æ¡ˆ (agent.py:98-105)                        â”‚
â”‚  - æ”¶é›†æ‰€æœ‰ text ç±»å‹çš„ chunk                                     â”‚
â”‚  - è·³è¿‡ tool_call å’Œ tool_call_result                             â”‚
â”‚  - result = "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 8: è¿”å›å“åº”ç»™ç”¨æˆ·                                           â”‚
â”‚  - è¿”å›: QueryResponse(answer="åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—...")              â”‚
â”‚  - HTTP 200 OK                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®æ­¥éª¤è¯¦è§£

**Step 1-2ï¼šè¯·æ±‚æ¥æ”¶ä¸è½¬æ¢**

`agent.py:98-105`
```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    # Step 2: è½¬æ¢ä¸º OpenAI æ¶ˆæ¯æ ¼å¼
    messages = req.to_messages()
    # ç»“æœï¼š
    # [
    #   {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ª Research Agent..."},
    #   {"role": "user", "content": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}
    # ]
```

**Step 3-4ï¼šAgent Loop è°ƒç”¨**

`agent_loop.py:168-293`
```python
async for chunk in agent_loop(messages, [web_search, get_weather]):
    # Step 4: LLM è¿”å›å·¥å…·è°ƒç”¨
    if chunk.type == "tool_call":
        print(f"LLM æƒ³è°ƒç”¨å·¥å…·: {chunk.tool_call.tool_name}")
```

**Step 5ï¼šå·¥å…·æ‰§è¡Œ**

`agent_loop.py:258-290`
```python
# æŸ¥æ‰¾å‡½æ•°
func = tool_functions_map[func_name]

# æ‰§è¡Œ
result = func(**parsed_args)
# ä¾‹å¦‚ï¼šget_weather(location="åŒ—äº¬")
# è¿”å›ï¼š "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸© 10-20â„ƒ"
```

**Step 6ï¼šç¬¬äºŒè½®å¾ªç¯**

å·¥å…·ç»“æœè¢«è¿½åŠ åˆ°æ¶ˆæ¯å†å²ï¼ŒLLM åŸºäºè¿™äº›ä¿¡æ¯ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆï¼š
```python
prompt_messages.append({
    "role": "tool",
    "tool_call_id": call_id,
    "content": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸© 10-20â„ƒ"
})
```

**Step 7ï¼šè¿‡æ»¤ä¸­é—´è¿‡ç¨‹**

`agent.py:98-105`
```python
result = ""
async for chunk in agent_loop(...):
    if chunk.type == "tool_call" or chunk.type == "tool_call_result":
        result = ""  # â† æ¸…ç©ºï¼Œè·³è¿‡ä¸­é—´è¿‡ç¨‹
    elif chunk.type == "text" and chunk.content:
        result += chunk.content  # â† åªä¿ç•™æœ€ç»ˆç­”æ¡ˆ
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### ReAct æ¨¡å¼

**ReAct** = **Reasoningï¼ˆæ¨ç†ï¼‰** + **Actingï¼ˆè¡ŒåŠ¨ï¼‰**

è¿™æ˜¯ä¸€ç§è®© LLM èƒ½å¤Ÿ"è¾¹æ€è€ƒè¾¹è¡ŒåŠ¨"çš„æ¨¡å¼ï¼Œè€Œä¸æ˜¯åªå‡­å¹»è§‰ç”Ÿæˆç­”æ¡ˆã€‚ReAct é€šè¿‡ä»¥ä¸‹å¾ªç¯å·¥ä½œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ€è€ƒ â†’ LLM åˆ†æé—®é¢˜ï¼Œå†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·           â”‚
â”‚  2. è¡ŒåŠ¨ â†’ è°ƒç”¨å·¥å…·ï¼ˆå¦‚ web_searchï¼‰è·å–ä¿¡æ¯            â”‚
â”‚  3. è§‚å¯Ÿ â†’ å°†å·¥å…·ç»“æœåé¦ˆç»™ LLM                        â”‚
â”‚  4. ç»§ç»­ â†’ LLM åŸºäºè§‚å¯Ÿç»“æœç»§ç»­æ¨ç†æˆ–ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„å®ç°

æ ¸å¿ƒå®ç°åœ¨ `agent_loop.py:168-293` çš„ `while True` å¾ªç¯ï¼š

```python
while True:
    # 1ï¸âƒ£ æ€è€ƒï¼šLLM ç”Ÿæˆå“åº”ï¼ˆå¯èƒ½åŒ…å«å·¥å…·è°ƒç”¨ï¼‰
    stream = await client.chat.completions.create(
        messages=prompt_messages, **params
    )

    # 2ï¸âƒ£ å¤„ç† LLM è¿”å›çš„æµå¼å†…å®¹
    async for chunk in stream:
        if delta.content:
            yield Chunk(type="text", content=delta.content)  # æ™®é€šæ–‡æœ¬
        if delta.tool_calls:
            # ç´¯ç§¯å·¥å…·è°ƒç”¨å‚æ•°
            tool_calls_buffer[idx]["function"]["arguments"] += chunk

    # 3ï¸âƒ£ è¡ŒåŠ¨ï¼šå¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ‰§è¡Œå·¥å…·
    for tool_data in assistant_tool_calls_data:
        func = tool_functions_map[func_name]
        result = func(**parsed_args)  # æ‰§è¡Œ web_search ç­‰å‡½æ•°

        # 4ï¸âƒ£ è§‚å¯Ÿï¼šå°†ç»“æœå›ä¼ ç»™ LLM
        prompt_messages.append({
            "role": "tool",
            "tool_call_id": call_id,
            "content": tool_result_content
        })

    if not tool_calls_buffer:
        break  # æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œé€€å‡ºå¾ªç¯
```

#### å®é™…ä¾‹å­

**ç”¨æˆ·é—®é¢˜**ï¼š*åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ*

| æ­¥éª¤ | ç±»å‹ | å†…å®¹ |
|------|------|------|
| 1ï¸âƒ£ æ€è€ƒ | tool_call | è°ƒç”¨ `get_weather(location="åŒ—äº¬")` |
| 2ï¸âƒ£ è¡ŒåŠ¨ | æ‰§è¡Œå‡½æ•° | è¿”å› `"åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸© 10-20â„ƒ"` |
| 3ï¸âƒ£ è§‚å¯Ÿ | tool_result | å°†ç»“æœè¿½åŠ åˆ°æ¶ˆæ¯å†å² |
| 4ï¸âƒ£ ç»§ç»­ | text | "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚" |

---

### Function Callingï¼ˆå·¥å…·è°ƒç”¨ï¼‰

Function Calling è®© LLM èƒ½å¤Ÿ"è°ƒç”¨"ä½ çš„ Python å‡½æ•°ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

#### æ­¥éª¤ 1ï¼šå°† Python å‡½æ•°è½¬æ¢ä¸º JSON Schema

`agent_loop.py:64-97` ä¸­çš„ `function_to_schema` å‡½æ•°è´Ÿè´£è½¬æ¢ï¼š

```python
def function_to_schema(func: Callable) -> dict:
    # ä¾‹å¦‚ï¼šweb_search(query: str, top_k: int = 5) -> str

    return {
        "type": "function",
        "function": {
            "name": "web_search",
            "description": "Perform a web search to retrieve top results...",
            "parameters": {
                "type": "object",
                "properties": {
                    "query": {"type": "string"},
                    "top_k": {"type": "integer", "default": 5}
                },
                "required": ["query"]
            }
        }
    }
```

**å…³é”®ç‚¹**ï¼š
- é€šè¿‡ `inspect.signature()` è·å–å‡½æ•°å‚æ•°
- é€šè¿‡ `get_type_hints()` è·å–ç±»å‹æ³¨è§£
- é€šè¿‡ `func.__doc__` è·å–å‡½æ•°æè¿°ï¼ˆä¾› LLM è¯†åˆ«ä½•æ—¶è°ƒç”¨ï¼‰

#### æ­¥éª¤ 2ï¼šLLM è¿”å›å·¥å…·è°ƒç”¨è¯·æ±‚

å½“ LLM éœ€è¦è°ƒç”¨å·¥å…·æ—¶ï¼Œè¿”å›ç‰¹æ®Šçš„å·¥å…·è°ƒç”¨ç»“æ„ï¼š

```json
{
  "role": "assistant",
  "tool_calls": [
    {
      "id": "call_abc123",
      "type": "function",
      "function": {
        "name": "web_search",
        "arguments": "{\"query\": \"åŒ—äº¬å¤©æ°”\", \"top_k\": 3}"
      }
    }
  ]
}
```

#### æ­¥éª¤ 3ï¼šè§£æå¹¶æ‰§è¡Œ Python å‡½æ•°

`agent_loop.py:258-290` å¤„ç†æ‰§è¡Œï¼š

```python
# è§£æ JSON å‚æ•°
parsed_args = json.loads(func_args_str)  # {"query": "åŒ—äº¬å¤©æ°”", "top_k": 3}

# æŸ¥æ‰¾å‡½æ•°
func = tool_functions_map["web_search"]  # å®é™…çš„ Python å‡½æ•°

# æ‰§è¡Œï¼ˆæ”¯æŒå¼‚æ­¥ï¼‰
if iscoroutinefunction(func):
    result = await func(**parsed_args)
else:
    result = func(**parsed_args)

# å°†ç»“æœè¿”å›ç»™ LLM
prompt_messages.append({
    "role": "tool",
    "tool_call_id": "call_abc123",
    "content": str(result)  # æœç´¢ç»“æœ
})
```

#### æµå¼å¤„ç†çš„æŒ‘æˆ˜

LLM æ˜¯æµå¼è¿”å›çš„ï¼Œ`arguments` åˆ†ç‰‡æ®µä¼ å›ï¼š

```
ç‰‡æ®µ1: {"query": "
ç‰‡æ®µ2: åŒ—äº¬å¤©æ°”
ç‰‡æ®µ3: ", "top_k": 3}
```

ä»£ç é€šè¿‡ `tool_calls_buffer` ç´¯ç§¯è¿™äº›ç‰‡æ®µï¼Œå®Œæ•´æ‹¼æ¥åæ‰èƒ½è§£æ JSONã€‚

---

### Agent Skills ç³»ç»Ÿ

#### ä¸ºä»€ä¹ˆéœ€è¦ Skillsï¼Ÿ

å¦‚æœä¸ä½¿ç”¨ Skillsï¼Œæ‰€æœ‰æŒ‡ä»¤å†™åœ¨ç³»ç»Ÿæç¤ºè¯é‡Œä¼šå¸¦æ¥é—®é¢˜ï¼š

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| âŒ æç¤ºè¯è¿‡é•¿ | è¶…è¿‡ä¸Šä¸‹æ–‡é™åˆ¶ï¼Œé™ä½å“åº”è´¨é‡ |
| âŒ éš¾ä»¥ç»´æŠ¤ | ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½éœ€è¦æ”¹åŠ¨æ•´ä¸ªæç¤ºè¯ |
| âŒ æ— æ³•åŠ¨æ€åŠ è½½ | ä¸èƒ½æ ¹æ®éœ€æ±‚é€‰æ‹©æ€§å¯ç”¨æŠ€èƒ½ |

#### Skills çš„è®¾è®¡ç†å¿µ

éµå¾ª [Agent Skills è§„èŒƒ](https://agentskills.io)ï¼Œæ¯ä¸ªæŠ€èƒ½æ˜¯åŒ…å« `SKILL.md` çš„æ–‡ä»¶å¤¹ï¼š

```
skills/
â”œâ”€â”€ get-current-time/
â”‚   â”œâ”€â”€ SKILL.md           # æŠ€èƒ½å…ƒæ•°æ®å’ŒæŒ‡ä»¤
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ now.py         # å¯é€‰çš„æ‰§è¡Œè„šæœ¬
â””â”€â”€ create-plan/
    â””â”€â”€ SKILL.md
```

#### SKILL.md çš„ç»“æ„

```yaml
---
name: get-current-time
description: å½“ç”¨æˆ·è¯¢é—®å½“å‰æ—¶é—´ã€æ—¥æœŸæ—¶ä½¿ç”¨æ­¤æŠ€èƒ½
---

# è·å–å½“å‰æ—¶é—´

è¯·ä½¿ç”¨ get_current_time å·¥å…·è·å–ç³»ç»Ÿæ—¶é—´ï¼Œå¹¶æŒ‰ä»¥ä¸‹æ ¼å¼è¿”å›ï¼š
- æ—¥æœŸï¼šYYYYå¹´MMæœˆDDæ—¥
- æ—¶é—´ï¼šHH:MM:SS
```

#### å¦‚ä½•é›†æˆåˆ°ç³»ç»Ÿ

`skills.py` çš„ `build_skills_system_prompt` å‡½æ•°å°†æ‰€æœ‰æŠ€èƒ½æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºè¯ï¼š

```python
# agent_loop.py:115-133
skills_prompt = build_skills_system_prompt(skills)

# æ³¨å…¥åˆ°ç³»ç»Ÿæ¶ˆæ¯
if prompt_messages[0].get("role") == "system":
    original_content = prompt_messages[0].get("content", "")
    prompt_messages[0] = {
        "role": "system",
        "content": f"{original_content}\n\n{skills_prompt}",
    }
```

#### æŠ€èƒ½åŠ è½½ä¸æ‰§è¡Œ

Skills å¯ä»¥åŒ…å«å¯æ‰§è¡Œè„šæœ¬ï¼š

```python
# agent_loop.py:143-145
skill_tools = SkillIntegrationTools(skills)
llm_tools.extend([
    skill_tools.load_skill_file,   # è¯»å– SKILL.md å†…å®¹
    skill_tools.execute_script     # æ‰§è¡Œ scripts/ ä¸‹çš„ Python è„šæœ¬
])
```

è¿™æ · LLM å¯ä»¥ï¼š
1. åŠ¨æ€è¯»å–æŠ€èƒ½æ–‡æ¡£
2. æ‰§è¡ŒæŠ€èƒ½è„šæœ¬å®Œæˆç‰¹å®šä»»åŠ¡

---

## è¿›é˜¶é—®é¢˜

### Q4: å·¥å…·å‡½æ•°å¦‚ä½•å®šä¹‰æ‰èƒ½è¢« LLM è¯†åˆ«å’Œè°ƒç”¨ï¼Ÿ

#### ç­”æ¡ˆï¼šå·¥å…·å‡½æ•°éœ€è¦æ»¡è¶³ä¸‰ä¸ªå…³é”®è¦æ±‚

æŸ¥çœ‹ `agent.py:38-61` çš„ `web_search` å‡½æ•°ï¼š

```python
def web_search(query: str, top_k: int = 5) -> str:
    """
    Perform a web search to retrieve top results (title, snippet, url).
    Prefer calling this when you need external information or evidence.
    """
    # å‡½æ•°å®ç°...
```

#### è¦æ±‚ 1ï¼šç±»å‹æç¤ºï¼ˆType Hintsï¼‰

```python
def web_search(query: str, top_k: int = 5) -> str:
#                  â†‘         â†‘                   â†‘
#                å‚æ•°ç±»å‹   å‚æ•°é»˜è®¤å€¼          è¿”å›å€¼ç±»å‹
```

**ä¸ºä»€ä¹ˆéœ€è¦ç±»å‹æç¤ºï¼Ÿ**

`function_to_schema` å‡½æ•°é€šè¿‡ç±»å‹æç¤ºè‡ªåŠ¨ç”Ÿæˆ JSON Schemaï¼š

```python
# agent_loop.py:64-97
def function_to_schema(func: Callable) -> dict:
    type_hints = get_type_hints(func)  # è·å–ç±»å‹æç¤º
    signature = inspect.signature(func)  # è·å–å‡½æ•°ç­¾å

    # è½¬æ¢ä¸º JSON Schema
    parameters = {
        "type": "object",
        "properties": {
            "query": {"type": "string"},
            "top_k": {"type": "integer", "default": 5}
        },
        "required": ["query"]  # æ²¡æœ‰é»˜è®¤å€¼çš„å‚æ•°æ˜¯å¿…éœ€çš„
    }
```

**ç±»å‹æ˜ å°„å…³ç³»**ï¼š

| Python ç±»å‹ | JSON ç±»å‹ |
|------------|-----------|
| `str` | `"string"` |
| `int` | `"integer"` |
| `float` | `"number"` |
| `bool` | `"boolean"` |
| `list` | `"array"` |
| `dict` | `"object"` |

#### è¦æ±‚ 2ï¼šæ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆDocstringï¼‰

```python
def web_search(query: str, top_k: int = 5) -> str:
    """
    Perform a web search to retrieve top results (title, snippet, url).
    Prefer calling this when you need external information or evidence.
    """
```

**ä¸ºä»€ä¹ˆéœ€è¦ Docstringï¼Ÿ**

Docstring ä¼šæˆä¸ºå·¥å…·çš„ `description`ï¼Œå‘Šè¯‰ LLM **ä½•æ—¶**è°ƒç”¨è¿™ä¸ªå·¥å…·ï¼š

```json
{
  "type": "function",
  "function": {
    "name": "web_search",
    "description": "Perform a web search to retrieve top results (title, snippet, url). Prefer calling this when you need external information or evidence.",
    "parameters": {...}
  }
}
```

**Docstring çš„æœ€ä½³å®è·µ**ï¼š

| âœ… å¥½çš„ Docstring | âŒ ä¸å¥½çš„ Docstring |
|------------------|-------------------|
| "æœç´¢ç½‘é¡µè·å–ä¿¡æ¯ï¼Œå½“éœ€è¦å¤–éƒ¨è¯æ®æ—¶ä½¿ç”¨" | "æœç´¢å‡½æ•°" |
| "è·å–å¤©æ°”ä¿¡æ¯ï¼Œå½“ç”¨æˆ·è¯¢é—®å¤©æ°”æ—¶è°ƒç”¨" | "get_weather" |
| "è®¡ç®—æ•°å­¦è¡¨è¾¾å¼ï¼Œå½“é‡åˆ°ç®—æœ¯é—®é¢˜æ—¶ä½¿ç”¨" | "è®¡ç®—å‡½æ•°" |

#### è¦æ±‚ 3ï¼šè¿”å›å­—ç¬¦ä¸²

```python
def web_search(query: str, top_k: int = 5) -> str:
    # ...
    return json.dumps({"source": "serpapi", "results": items}, ensure_ascii=False)
```

**ä¸ºä»€ä¹ˆè¿”å›å­—ç¬¦ä¸²ï¼Ÿ**

å·¥å…·çš„è¿”å›å€¼ä¼šè¢«ç›´æ¥æ·»åŠ åˆ° LLM çš„æ¶ˆæ¯å†å²ä¸­ï¼š

```python
prompt_messages.append({
    "role": "tool",
    "tool_call_id": call_id,
    "content": str(result)  # â† è½¬æ¢ä¸ºå­—ç¬¦ä¸²
})
```

#### å®Œæ•´ç¤ºä¾‹ï¼šå®šä¹‰ä¸€ä¸ªæ–°å·¥å…·

```python
def calculate(expression: str) -> str:
    """
    Calculate a mathematical expression safely.
    Use this when the user needs to perform arithmetic calculations.
    Supports basic operations: +, -, *, /, parentheses.
    """
    try:
        result = eval(expression, {"__builtins__": {}}, {})
        return str(result)
    except Exception as e:
        return f"Error: {str(e)}"
```

#### æ³¨å†Œå·¥å…·

åœ¨ `agent.py` ä¸­ï¼Œå°†å·¥å…·å‡½æ•°ä¼ é€’ç»™ `agent_loop`ï¼š

```python
# agent.py:98-105
async for chunk in agent_loop(req.to_messages(), [web_search, get_weather, calculate]):
    # ...
```

---

### Q5: æµå¼å“åº”ï¼ˆ`/stream`ï¼‰å’Œéæµå¼å“åº”ï¼ˆ`/`ï¼‰æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

#### ç­”æ¡ˆï¼šè¿”å›æ–¹å¼å’Œç”¨æˆ·ä½“éªŒä¸åŒ

#### éæµå¼å“åº”ï¼ˆ`POST /`ï¼‰

**ä»£ç ä½ç½®**ï¼š`agent.py:98-105`

```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    result = ""

    async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
        if chunk.type == "tool_call" or chunk.type == "tool_call_result":
            result = ""  # é‡ç½®ï¼Œè·³è¿‡ä¸­é—´è¿‡ç¨‹
        elif chunk.type == "text" and chunk.content:
            result += chunk.content

    # ç­‰å¾…æ‰€æœ‰å†…å®¹ç”Ÿæˆå®Œæˆåä¸€æ¬¡æ€§è¿”å›
    return QueryResponse(answer=result)
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç­‰å¾…å®Œæ•´ç­”æ¡ˆç”Ÿæˆåä¸€æ¬¡æ€§è¿”å›
- âœ… é€‚åˆéœ€è¦å®Œæ•´ç»“æœçš„åœºæ™¯
- âŒ ç”¨æˆ·éœ€è¦ç­‰å¾…è¾ƒé•¿æ—¶é—´æ‰èƒ½çœ‹åˆ°ç»“æœ

**å“åº”æ ¼å¼**ï¼š
```json
{
  "answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"
}
```

#### æµå¼å“åº”ï¼ˆ`POST /stream`ï¼‰

**ä»£ç ä½ç½®**ï¼š`agent.py:107-126`

```python
@app.post("/stream")
async def stream(req: QueryRequest) -> StreamingResponse:
    async def stream_response():
        async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
            if chunk.type == "text" and chunk.content:
                data = {"answer": chunk.content}
                # å®æ—¶å‘é€æ¯ä¸ªæ–‡æœ¬ç‰‡æ®µ
                yield f"data: {json.dumps(data, ensure_ascii=False)}\n\n"

    return StreamingResponse(stream_response(), media_type="text/event-stream")
```

**ç‰¹ç‚¹**ï¼š
- âœ… å®æ—¶å‘é€ç”Ÿæˆçš„æ–‡æœ¬ç‰‡æ®µ
- âœ… ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°ç­”æ¡ˆçš„å¼€å§‹éƒ¨åˆ†
- âœ… é€‚åˆé•¿ç­”æ¡ˆæˆ–å¤æ‚æ¨ç†
- âŒ å®ç°æ›´å¤æ‚ï¼Œéœ€è¦å¤„ç† SSE åè®®

**å“åº”æ ¼å¼**ï¼ˆServer-Sent Eventsï¼‰ï¼š
```
data: {"answer": "åŒ—äº¬"}

data: {"answer": "ä»Šå¤©"}

data: {"answer": "å¤©æ°”"}

data: {"answer": "æ™´æœ—"}
```

#### å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | éæµå¼ï¼ˆ`/`ï¼‰ | æµå¼ï¼ˆ`/stream`ï¼‰ |
|------|--------------|------------------|
| è¿”å›æ–¹å¼ | ä¸€æ¬¡æ€§è¿”å› | é€ç‰‡æ®µå®æ—¶è¿”å› |
| ç­‰å¾…æ—¶é—´ | éœ€ç­‰å¾…å®Œæ•´ç­”æ¡ˆ | ç«‹å³çœ‹åˆ°å¼€å§‹éƒ¨åˆ† |
| ç”¨æˆ·ä½“éªŒ | ç®€å•ç›´æ¥ | æ›´æµç•…ï¼Œé€‚åˆé•¿å†…å®¹ |
| å®ç°å¤æ‚åº¦ | ç®€å• | éœ€è¦å¤„ç† SSE åè®® |
| é€‚ç”¨åœºæ™¯ | çŸ­ç­”æ¡ˆã€API é›†æˆ | é•¿ç­”æ¡ˆã€å¤æ‚æ¨ç†ã€èŠå¤©ç•Œé¢ |

#### ä¸ºä»€ä¹ˆæµå¼é€‚åˆé•¿ç­”æ¡ˆï¼Ÿ

```
å‡è®¾ LLM ç”Ÿæˆä¸€ä¸ª 500 å­—çš„ç­”æ¡ˆï¼š

éæµå¼å“åº”ï¼š
ç”¨æˆ·ç­‰å¾… â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”> (5ç§’) çœ‹åˆ°å®Œæ•´ç­”æ¡ˆ

æµå¼å“åº”ï¼š
ç”¨æˆ·çœ‹åˆ° â”â”â”â”â”â”> (1ç§’) "åŒ—äº¬ä»Šå¤©å¤©æ°”..."
       â”â”â”â”â”â”â”â”â”â”â”> (2ç§’) "æ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´..."
       â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”> (5ç§’) "ç©ºæ°”è´¨é‡è‰¯å¥½ã€‚"
```

æµå¼å“åº”è®©ç”¨æˆ·æ„Ÿè§‰"ç­”æ¡ˆæ­£åœ¨ç”Ÿæˆ"ï¼Œå‡å°‘ç­‰å¾…ç„¦è™‘ã€‚

---

### Q6: å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„ Skillï¼Ÿ

#### ç­”æ¡ˆï¼šåœ¨ `skills/` ç›®å½•ä¸‹åˆ›å»ºåŒ…å« `SKILL.md` çš„æ–‡ä»¶å¤¹

#### Skill çš„ç›®å½•ç»“æ„

```
skills/
â”œâ”€â”€ get-current-time/      # ç°æœ‰æŠ€èƒ½
â”‚   â”œâ”€â”€ SKILL.md           # â† å¿…éœ€ï¼šæŠ€èƒ½å…ƒæ•°æ®å’ŒæŒ‡ä»¤
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ now.py         # â† å¯é€‰ï¼šæ‰§è¡Œè„šæœ¬
â””â”€â”€ my-new-skill/          # æ–°æŠ€èƒ½
    â”œâ”€â”€ SKILL.md
    â””â”€â”€ scripts/
        â””â”€â”€ my_script.py
```

#### SKILL.md çš„ç»“æ„

æŸ¥çœ‹ `skills/get-current-time/SKILL.md`ï¼š

```yaml
---
name: get-current-time
description: Get the current accurate system time. Use when the user asks for the current time or when a real timestamp is required.
---

# Get Current Time

## Goal

Get the current accurate system time (UTC and local time).

## Script

Execute the script to get the current system time.

```shell
python scripts/now.py
```
```

#### SKILL.md çš„ç»„æˆéƒ¨åˆ†

**1. YAML å‰ç½®å…ƒæ•°æ®ï¼ˆå¿…éœ€ï¼‰**

```yaml
---
name: skill-name          # æŠ€èƒ½åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
description: ...          # æŠ€èƒ½æè¿°ï¼Œå‘Šè¯‰ LLM ä½•æ—¶ä½¿ç”¨
---
```

**`name`**ï¼šæŠ€èƒ½çš„å”¯ä¸€æ ‡è¯†ç¬¦
- ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦
- ä¾‹å¦‚ï¼š`get-current-time`, `search-wikipedia`

**`description`**ï¼šæŠ€èƒ½çš„ä½¿ç”¨åœºæ™¯
- å‘Šè¯‰ LLM ä½•æ—¶æ¿€æ´»è¿™ä¸ªæŠ€èƒ½
- ä¾‹å¦‚ï¼š*"Use when the user asks for the current time"*

**2. Markdown å†…å®¹ï¼ˆå¿…éœ€ï¼‰**

æŠ€èƒ½çš„å…·ä½“æŒ‡ä»¤ï¼Œå‘Šè¯‰ LLM å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæŠ€èƒ½ï¼š

```markdown
# Get Current Time

## Goal

Get the current accurate system time.

## Steps

1. Execute the script to get the current time
2. Format the result as "YYYY-MM-DD HH:MM:SS"
3. Return to the user
```

**3. Script å—ï¼ˆå¯é€‰ï¼‰**

å¦‚æœéœ€è¦æ‰§è¡Œå¤–éƒ¨è„šæœ¬ï¼Œå¯ä»¥åŒ…å«è„šæœ¬æ‰§è¡ŒæŒ‡ä»¤ï¼š

```markdown
## Script

Execute the script:

```shell
python scripts/now.py
```
```

#### Skill vs å·¥å…·å‡½æ•°çš„åŒºåˆ«

| ç‰¹æ€§ | å·¥å…·å‡½æ•°ï¼ˆTool Functionï¼‰ | Skill |
|------|------------------------|-------|
| å®šä¹‰ä½ç½® | `agent.py` | `skills/` ç›®å½• |
| ä»£ç ç±»å‹ | Python å‡½æ•° | Markdown æ–‡æ¡£ï¼ˆ+ å¯é€‰è„šæœ¬ï¼‰ |
| ä¸»è¦ç”¨é€” | æ‰§è¡Œå…·ä½“æ“ä½œ | æä¾›å¤æ‚æŒ‡ä»¤å’Œå·¥ä½œæµ |
| å‚æ•°ä¼ é€’ | é€šè¿‡å‡½æ•°å‚æ•° | é€šè¿‡æ–‡æ¡£æŒ‡ä»¤ |
| LLM è¯†åˆ«æ–¹å¼ | JSON Schema | æè¿°å…ƒæ•°æ® |
| çµæ´»æ€§ | å›ºå®šé€»è¾‘ | å¯åŒ…å«å¤šæ­¥éª¤æŒ‡å¯¼ |

#### åˆ›å»ºæ–° Skill ç¤ºä¾‹ï¼šæœç´¢ Wikipedia

**Step 1: åˆ›å»ºç›®å½•**

```
skills/
â””â”€â”€ search-wikipedia/
    â””â”€â”€ SKILL.md
```

**Step 2: ç¼–å†™ SKILL.md**

```yaml
---
name: search-wikipedia
description: Search Wikipedia for encyclopedic information. Use when the user asks for factual information, historical events, or detailed explanations about a topic.
---

# Search Wikipedia

## Goal

Retrieve accurate and comprehensive information from Wikipedia.

## Steps

1. Use the web_search tool with the query formatted as "{topic} site:wikipedia.org"
2. Analyze the search results and select the most relevant Wikipedia article
3. Read the article content (if accessible) or use the snippet
4. Summarize the key information in a clear, structured format
5. Include the Wikipedia URL as a reference

## Example

For a query "What is photosynthesis?":

1. Search: "photosynthesis site:wikipedia.org"
2. Find the Wikipedia article
3. Extract: definition, process steps, importance
4. Return summary with Wikipedia link
```

**Step 3: è‡ªåŠ¨åŠ è½½**

`skills.py` ä¼šè‡ªåŠ¨å‘ç° `skills/` ç›®å½•ä¸‹çš„æ‰€æœ‰ Skillï¼š

```python
# agent_loop.py:115-118
skills = discover_skills(skill_directories) if skill_directories else []
```

#### å¦‚ä½•ä½¿ç”¨ Skillï¼Ÿ

LLM ä¼šæ ¹æ® `description` è‡ªåŠ¨å†³å®šä½•æ—¶ä½¿ç”¨ Skillï¼š

```
ç”¨æˆ·ï¼šå‘Šè¯‰æˆ‘å…³äºé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†

LLM åˆ†æï¼š
- è¿™æ˜¯ä¸€ä¸ªéœ€è¦å‡†ç¡®ç™¾ç§‘çŸ¥è¯†çš„é—®é¢˜
- æ£€æŸ¥å¯ç”¨ Skill â†’ å‘ç° "search-wikipedia"
- æ¿€æ´» Skill â†’ æŒ‰ç…§ SKILL.md çš„æ­¥éª¤æ‰§è¡Œ
```

---

## ğŸ“ æ€»ç»“

| æ¦‚å¿µ | æ ¸å¿ƒä½œç”¨ | é¡¹ç›®ä¸­çš„ä½“ç° |
|------|----------|--------------|
| **ReAct** | è®© LLM èƒ½"æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿ"å¾ªç¯ | `agent_loop.py` çš„ `while True` ä¸»å¾ªç¯ |
| **Function Calling** | è®© LLM èƒ½è°ƒç”¨ Python å‡½æ•° | `function_to_schema` è½¬æ¢ + æ‰§è¡Œæ˜ å°„ |
| **Skills** | æ¨¡å—åŒ–ç®¡ç†å¤æ‚æŒ‡ä»¤ | `skills/` ç›®å½• + åŠ¨æ€æ³¨å…¥ç³»ç»Ÿæç¤ºè¯ |

| é—®é¢˜ | ç­”æ¡ˆ | å…³é”®ç‚¹ |
|------|------|--------|
| 1. æ ¸å¿ƒå…¥å£ | `agent.py` | FastAPI åº”ç”¨ï¼Œæä¾› 3 ä¸ª API æ¥å£ |
| 2. ä½¿ç”¨çš„æ¨¡å‹ | é˜¿é‡Œäº‘ç™¾ç‚¼ Qwen | å¤©æ± å¤§èµ›å¼ºåˆ¶è¦æ±‚ï¼Œéœ€è¦é…ç½® `DASHSCOPE_API_KEY` |
| 3. æ•°æ®æµ | 8 ä¸ªæ­¥éª¤ | è¯·æ±‚ â†’ æ¶ˆæ¯è½¬æ¢ â†’ Agent Loop â†’ å·¥å…·è°ƒç”¨ â†’ ç­”æ¡ˆè¿‡æ»¤ â†’ è¿”å› |
| 4. å¦‚ä½•å®šä¹‰å·¥å…·å‡½æ•° | éœ€è¦ç±»å‹æç¤ºã€Docstringã€è¿”å›å­—ç¬¦ä¸² | `function_to_schema` è‡ªåŠ¨è½¬æ¢ |
| 5. æµå¼ vs éæµå¼ | è¿”å›æ–¹å¼å’Œç”¨æˆ·ä½“éªŒä¸åŒ | æµå¼é€‚åˆé•¿ç­”æ¡ˆï¼Œéæµå¼é€‚åˆçŸ­ç­”æ¡ˆ |
| 6. å¦‚ä½•åˆ›å»º Skill | åˆ›å»ºåŒ…å« `SKILL.md` çš„æ–‡ä»¶å¤¹ | å…ƒæ•°æ® + Markdown æŒ‡ä»¤ |

| å¯¹æ¯” | å·¥å…·å‡½æ•° | Skill |
|------|---------|-------|
| å®šä¹‰ä½ç½® | `agent.py` | `skills/` ç›®å½• |
| ä»£ç ç±»å‹ | Python å‡½æ•° | Markdown æ–‡æ¡£ |
| ä¸»è¦ç”¨é€” | æ‰§è¡Œå…·ä½“æ“ä½œ | æä¾›å¤æ‚æŒ‡ä»¤å’Œå·¥ä½œæµ |

---

## å®è·µä¸»é¢˜

### ä¸»é¢˜ 1ï¼šé”™è¯¯å¤„ç†æœºåˆ¶â€”â€”å·¥å…·è°ƒç”¨å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

#### ä¸‰å±‚é”™è¯¯å¤„ç†æ¶æ„

æœ¬é¡¹ç›®åœ¨ `agent_loop.py:258-290` å®ç°äº†ä¸‰å±‚é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
for tool_data in assistant_tool_calls_data:
    call_id = tool_data["id"]
    func_name = tool_data["function"]["name"]
    func_args_str = tool_data["function"]["arguments"]

    tool_result_content = ""

    try:
        # ğŸ”´ ç¬¬ä¸€å±‚ï¼šJSON è§£æé”™è¯¯
        parsed_args = json.loads(func_args_str)

        # ğŸ”µ ç¬¬äºŒå±‚ï¼šå‡½æ•°æ‰§è¡Œé”™è¯¯
        if func_name in tool_functions_map:
            func = tool_functions_map[func_name]
            if iscoroutinefunction(func):
                result = await func(**parsed_args)
            else:
                result = func(**parsed_args)
            tool_result_content = str(result)
        else:
            # ğŸŸ¢ ç¬¬ä¸‰å±‚ï¼šå·¥å…·ä¸å­˜åœ¨é”™è¯¯
            tool_result_content = f"Error: Tool '{func_name}' not found."

    except json.JSONDecodeError as e:
        tool_result_content = f"Error: Failed to parse tool arguments JSON: {func_args_str}. Error: {e}"

    except Exception as e:
        tool_result_content = f"Error: Execution failed - {str(e)}"
```

#### ç¬¬ä¸€å±‚ï¼šJSON è§£æé”™è¯¯

**åœºæ™¯**ï¼šLLM è¿”å›çš„å·¥å…·è°ƒç”¨å‚æ•°ä¸æ˜¯æœ‰æ•ˆçš„ JSON

```python
except json.JSONDecodeError as e:
    tool_result_content = f"Error: Failed to parse tool arguments JSON: {func_args_str}. Error: {e}"
```

**è§¦å‘æ¡ä»¶**ï¼š
- JSON æ ¼å¼ä¸æ­£ç¡®ï¼ˆç¼ºå°‘å¼•å·ã€é€—å·ç­‰ï¼‰
- å‚æ•°ç±»å‹ä¸åŒ¹é…
- æµå¼ä¼ è¾“æ—¶ç‰‡æ®µæ‹¼æ¥é”™è¯¯

**ç¤ºä¾‹**ï¼š
```
LLM è¿”å›: {"query": "åŒ—äº¬å¤©æ°”, "top_k": 5}
                              â†‘ ç¼ºå°‘å¼•å·

è§£æç»“æœ: Error: Failed to parse tool arguments JSON: {...}. Error: Expecting ',' delimiter: line 1 column 20 (char 19)
```

#### ç¬¬äºŒå±‚ï¼šå‡½æ•°æ‰§è¡Œé”™è¯¯

**åœºæ™¯**ï¼šå·¥å…·å‡½æ•°å†…éƒ¨æŠ›å‡ºå¼‚å¸¸

```python
except Exception as e:
    tool_result_content = f"Error: Execution failed - {str(e)}"
```

**å¸¸è§è§¦å‘æ¡ä»¶**ï¼š
- ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼ˆè¶…æ—¶ã€DNS é”™è¯¯ï¼‰
- API å¯†é’¥æ— æ•ˆæˆ–é…é¢è€—å°½
- å‚æ•°éªŒè¯å¤±è´¥
- å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨

**ç¤ºä¾‹ï¼ˆweb_search å‡½æ•°ï¼‰**ï¼š
```python
def web_search(query: str, top_k: int = 5) -> str:
    try:
        # ... æœç´¢é€»è¾‘ ...
        with urllib.request.urlopen(req, context=ctx, timeout=15) as resp:
            data = json.loads(resp.read().decode("utf-8", "replace"))
        # ...
    except Exception as e:
        # è¿”å› JSON æ ¼å¼çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
        return json.dumps({"error": f"search_failed: {str(e)}"}, ensure_ascii=False)
```

**é”™è¯¯ä¿¡æ¯è¿”å›ç»™ LLM**ï¼š
```json
{
  "error": "search_failed: HTTP Error 401: Unauthorized",
  "source": "serpapi"
}
```

#### ç¬¬ä¸‰å±‚ï¼šå·¥å…·ä¸å­˜åœ¨é”™è¯¯

**åœºæ™¯**ï¼šLLM è°ƒç”¨äº†ä¸å­˜åœ¨çš„å·¥å…·

```python
if func_name in tool_functions_map:
    # æ‰§è¡Œå·¥å…·
else:
    tool_result_content = f"Error: Tool '{func_name}' not found."
```

**è§¦å‘æ¡ä»¶**ï¼š
- å·¥å…·åç§°æ‹¼å†™é”™è¯¯
- å·¥å…·æœªæ³¨å†Œåˆ° `agent_loop`
- é…ç½®é”™è¯¯å¯¼è‡´å·¥å…·åˆ—è¡¨ä¸ä¸€è‡´

#### å…³é”®è®¾è®¡ï¼šé”™è¯¯ä¿¡æ¯å›ä¼ ç»™ LLM

æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œç»“æœéƒ½ä¼šæ·»åŠ åˆ°æ¶ˆæ¯å†å²ï¼š

```python
prompt_messages.append({
    "role": "tool",
    "tool_call_id": call_id,
    "content": tool_result_content  # â† æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šå›ä¼ 
})
```

**è¿™è®© LLM èƒ½å¤Ÿ**ï¼š
1. çŸ¥é“å·¥å…·è°ƒç”¨å¤±è´¥äº†
2. ç†è§£å¤±è´¥çš„åŸå› 
3. è‡ªä¸»å†³å®šæ˜¯å¦é‡è¯•ã€æ¢å·¥å…·æˆ–åŸºäºå·²æœ‰çŸ¥è¯†å›ç­”

#### é”™è¯¯å¤„ç†ç¤ºä¾‹

```
ç”¨æˆ·ï¼šæœç´¢"2025å¹´ç¾å›½æ€»ç»Ÿå¤§é€‰ç»“æœ"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1è½®å¾ªç¯ï¼š                                                  â”‚
â”‚ LLM æ€è€ƒï¼šéœ€è¦æœç´¢ä¿¡æ¯                                       â”‚
â”‚ LLM è¡ŒåŠ¨ï¼šweb_search(query="2025å¹´ç¾å›½æ€»ç»Ÿå¤§é€‰ç»“æœ")        â”‚
â”‚                                                              â”‚
â”‚ å‡è®¾æœç´¢ API å¤±è´¥ï¼ˆç½‘ç»œè¶…æ—¶ï¼‰                                 â”‚
â”‚ å·¥å…·ç»“æœï¼šError: Execution failed - Connection timeout       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2è½®å¾ªç¯ï¼š                                                  â”‚
â”‚ LLM æ”¶åˆ°æ¶ˆæ¯å†å²ï¼š                                           â”‚
â”‚   - ç”¨æˆ·ï¼šæœç´¢"2025å¹´ç¾å›½æ€»ç»Ÿå¤§é€‰ç»“æœ"                        â”‚
â”‚   - assistantï¼šè°ƒç”¨ web_search(...)                        â”‚
â”‚   - toolï¼šError: Execution failed - Connection timeout       â”‚
â”‚                                                              â”‚
â”‚ LLM æ€è€ƒï¼šæœç´¢å¤±è´¥äº†ï¼Œä½†æˆ‘å¯ä»¥åŸºäºå·²æœ‰çŸ¥è¯†å›ç­”                â”‚
â”‚ LLM å›ç­”ï¼šæŠ±æ­‰ï¼Œæˆ‘æ— æ³•å®æ—¶æœç´¢ã€‚æ ¹æ®æˆ‘çš„çŸ¥è¯†ï¼Œ2024å¹´ç¾å›½...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

| âœ… å¥½çš„åšæ³• | âŒ ä¸å¥½çš„åšæ³• |
|------------|-------------|
| è¿”å›æè¿°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ | æŠ›å‡ºå¼‚å¸¸è®©ç¨‹åºå´©æºƒ |
| é”™è¯¯ä¿¡æ¯åŒ…å«å¤±è´¥åŸå›  | åªè¿”å› "Error" |
| LLM èƒ½ç†è§£é”™è¯¯å«ä¹‰ | è¿”å›æŠ€æœ¯å †æ ˆä¿¡æ¯ |
| å·¥å…·å‡½æ•°å†…éƒ¨å¤„ç†å¼‚å¸¸ | è®©å¼‚å¸¸ä¼ æ’­åˆ°ä¸Šå±‚ |

---

### ä¸»é¢˜ 2ï¼šæ‰¹é‡å¤„ç†â€”â€”å¦‚ä½•å¤„ç† question.jsonl ä¸­çš„å¤šä¸ªé—®é¢˜ï¼Ÿ

#### æ‰¹é‡å¤„ç†è„šæœ¬ï¼šrun_batch.py

`run_batch.py` æ˜¯ç”¨äºæ‰¹é‡å¤„ç†é—®é¢˜çš„è„šæœ¬ï¼Œç”¨äºå¤©æ± å¤§èµ›çš„è¯„æµ‹ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

æŸ¥çœ‹ `run_batch.py:28-38`ï¼š

```python
async def run_one(question: str) -> str:
    messages = [
        {
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªResearch Agentï¼Œéµå¾ªReActï¼šå½“éœ€è¦å¤–éƒ¨ä¿¡æ¯æˆ–è¯æ®æ—¶è°ƒç”¨ web_search å·¥å…·ï¼Œå¹¶åŸºäºæ£€ç´¢ç»“æœè¿›è¡Œå›ç­”ï¼›ç­”æ¡ˆå¿…é¡»ä¸ºçº¯æ–‡æœ¬ä¸”ä¸æé—®è¯­è¨€ä¸€è‡´ï¼›ä¸å¾—ç¡¬ç¼–ç ç­”æ¡ˆæˆ–è°ƒç”¨ç¬¬ä¸‰æ–¹AgentæœåŠ¡ã€‚",
        },
        {"role": "user", "content": question},
    ]
    result = ""
    async for chunk in agent_loop(messages, [web_search]):
        if chunk.type in ("tool_call", "tool_call_result"):
            result = ""
        elif chunk.type == "text" and chunk.content:
            result += chunk.content
    return result
```

#### æ‰¹é‡å¤„ç†æµç¨‹

**Step 1ï¼šè¯»å– question.jsonl**

```python
# run_batch.py:40-51
src = "question.jsonl"
out = "submission.jsonl"
if not os.path.exists(src):
    raise FileNotFoundError(src)

items: List[Dict[str, Any]] = []
with open(src, "r", encoding="utf-8") as f:
    for line in f:
        line = line.strip()
        if not line:
            continue
        items.append(json.loads(line))
```

**question.jsonl æ ¼å¼**ï¼š
```json
{"id": 0, "question": "ä¸€ä½æ¬§æ´²å­¦è€…çš„æŸé¡¹å¼€æºç¡¬ä»¶é¡¹ç›®..."}
{"id": 1, "question": "Who is the author of the article..."}
{"id": 2, "question": "ä¸€ä½ç ”ç©¶æµæ˜Ÿçš„å¤©æ–‡å­¦å®¶..."}
```

**Step 2ï¼šé€ä¸ªå¤„ç†é—®é¢˜**

```python
# run_batch.py:52-56
results: List[Dict[str, Any]] = []
for it in items:
    ans = await run_one(str(it.get("question") or ""))
    results.append({"id": it.get("id"), "answer": ans})
```

**Step 3ï¼šä¿å­˜ç»“æœåˆ° submission.jsonl**

```python
# run_batch.py:57-60
with open(out, "w", encoding="utf-8") as f:
    for r in results:
        f.write(json.dumps(r, ensure_ascii=False) + "\n")
```

**submission.jsonl æ ¼å¼**ï¼š
```json
{"id": 0, "answer": "RepRap"}
{"id": 1, "answer": "James Lockhart"}
{"id": 2, "answer": "Radio receiver"}
```

#### è¿è¡Œæ‰¹é‡å¤„ç†

```bash
python run_batch.py
```

#### æ‰¹é‡å¤„ç†çš„æ³¨æ„äº‹é¡¹

| æ³¨æ„äº‹é¡¹ | è¯´æ˜ |
|---------|------|
| **ç¯å¢ƒå˜é‡** | éœ€è¦é…ç½® `DASHSCOPE_API_KEY` å’Œæœç´¢ API å¯†é’¥ |
| **ä¸²è¡Œå¤„ç†** | å½“å‰å®ç°æ˜¯é€ä¸ªå¤„ç†ï¼Œä¸æ˜¯å¹¶å‘ |
| **é”™è¯¯å¤„ç†** | å•ä¸ªé—®é¢˜å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–é—®é¢˜ |
| **è¾“å‡ºæ ¼å¼** | å¿…é¡»ä¸¥æ ¼éµå¾ª `{"id": x, "answer": "..."}` æ ¼å¼ |

#### æ”¹è¿›å»ºè®®ï¼šæ·»åŠ é‡è¯•å’Œæ—¥å¿—

```python
async def run_one_with_retry(question: str, max_retries: int = 3) -> str:
    for attempt in range(max_retries):
        try:
            return await run_one(question)
        except Exception as e:
            print(f"Attempt {attempt + 1} failed: {e}")
            if attempt == max_retries - 1:
                return f"Error: Failed after {max_retries} attempts"
            await asyncio.sleep(1)  # ç­‰å¾…åé‡è¯•
```

#### å¹¶å‘ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

```python
async def main_concurrent():
    # è¯»å–æ‰€æœ‰é—®é¢˜
    items = [...]

    # å¹¶å‘å¤„ç†ï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰
    semaphore = asyncio.Semaphore(5)  # æœ€å¤š5ä¸ªå¹¶å‘

    async def process_with_limit(item):
        async with semaphore:
            ans = await run_one(item["question"])
            return {"id": item["id"], "answer": ans}

    tasks = [process_with_limit(it) for it in items]
    results = await asyncio.gather(*tasks)

    # ä¿å­˜ç»“æœ
    ...
```

#### å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | é”™è¯¯å¤„ç† | æ‰¹é‡å¤„ç† |
|------|---------|---------|
| **ä½ç½®** | `agent_loop.py` | `run_batch.py` |
| **ç›®çš„** | å¤„ç†å·¥å…·è°ƒç”¨å¤±è´¥ | å¤„ç†å¤šä¸ªè¯„æµ‹é—®é¢˜ |
| **æœºåˆ¶** | ä¸‰å±‚ try-except | é€ä¸ªå¤„ç† + ç»“æœä¿å­˜ |
| **è¾“å‡º** | é”™è¯¯ä¿¡æ¯å›ä¼ ç»™ LLM | `submission.jsonl` |
| **å…³é”®** | è®© LLM è‡ªä¸»æ¢å¤ | ä¸¥æ ¼éµå¾ªè¾“å‡ºæ ¼å¼ |

#### å®é™…åº”ç”¨åœºæ™¯

**é”™è¯¯å¤„ç†åº”ç”¨**ï¼š

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| æœç´¢ API è¶…æ—¶ | è¿”å›é”™è¯¯ä¿¡æ¯ï¼ŒLLM å¯é‡è¯•æˆ–åŸºäºçŸ¥è¯†å›ç­” |
| æœç´¢ API é…é¢è€—å°½ | è¿”å›é…é¢é”™è¯¯ï¼ŒLLM å¯è°ƒæ•´ç­–ç•¥ |
| å‚æ•°è§£æå¤±è´¥ | è¿”å›æ ¼å¼é”™è¯¯ï¼ŒLLM é‡æ–°ç”Ÿæˆå‚æ•° |
| å·¥å…·ä¸å­˜åœ¨ | è¿”å›å·¥å…·æœªæ‰¾åˆ°ï¼ŒLLM é€‰æ‹©å…¶ä»–å·¥å…· |

**æ‰¹é‡å¤„ç†åº”ç”¨**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| å¤©æ± å¤§èµ›è¯„æµ‹ | å¤„ç† `question.jsonl` ä¸­çš„æ‰€æœ‰é—®é¢˜ |
| æœ¬åœ°æµ‹è¯• | éªŒè¯ Agent å¯¹ä¸åŒé—®é¢˜çš„å›ç­”è´¨é‡ |
| æ€§èƒ½è¯„ä¼° | ç»Ÿè®¡å¹³å‡å“åº”æ—¶é—´ã€æˆåŠŸç‡ç­‰ |

---

## FastAPI æ¡†æ¶

### ä»€ä¹ˆæ˜¯ FastAPIï¼Ÿ

**FastAPI** æ˜¯ä¸€ä¸ªç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„ Python Web æ¡†æ¶ï¼Œç”¨äºæ„å»º APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ã€‚

#### ğŸ¯ æ ¸å¿ƒä½œç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI çš„ä½œç”¨                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®©ä½ çš„ Python ä»£ç å˜æˆä¸€ä¸ªç½‘ç»œæœåŠ¡ï¼Œå¯ä»¥è¢«å…¶ä»–ç¨‹åºè°ƒç”¨   â”‚
â”‚                                                             â”‚
â”‚  ç”¨æˆ·/å®¢æˆ·ç«¯ â”€â”€HTTP è¯·æ±‚â”€â”€> FastAPI â”€â”€> ä½ çš„ Python å‡½æ•°  â”‚
â”‚                    <â”€â”€HTTP å“åº”â”€â”€         <â”€â”€ è¿”å›æ•°æ®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆè¦ç”¨ FastAPIï¼Ÿ

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| ğŸš€ **å¿«é€Ÿ** | æ€§èƒ½æ¥è¿‘ Node.js å’Œ Go |
| ğŸ“ **ç®€å•** | ä»£ç ç®€æ´ï¼Œæ˜“äºå­¦ä¹  |
| ğŸ› ï¸ **è‡ªåŠ¨æ–‡æ¡£** | è‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ |
| ğŸ”’ **ç±»å‹å®‰å…¨** | ä½¿ç”¨ Python ç±»å‹æç¤º |
| ğŸŒ **æ ‡å‡†æ”¯æŒ** | å®Œå…¨å…¼å®¹ OpenAPI å’Œ JSON Schema |

#### FastAPI åŸºç¡€æ¦‚å¿µ

**ä»€ä¹ˆæ˜¯ APIï¼Ÿ**

APIï¼ˆApplication Programming Interfaceï¼‰å°±åƒä¸€ä¸ª**æœåŠ¡å‘˜**ï¼š

```
é¤å…åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰                                            â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”‚ ç‚¹èœï¼šæˆ‘è¦å®«ä¿é¸¡ä¸                                  â”‚
â”‚     â–¼                                                    â”‚
â”‚  æœåŠ¡å‘˜ï¼ˆAPIï¼‰                                           â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”‚ ä¼ è¾¾ç»™å¨æˆ¿ï¼š"å®«ä¿é¸¡ä¸ä¸€ä»½"                          â”‚
â”‚     â–¼                                                    â”‚
â”‚  å¨æˆ¿ï¼ˆä½ çš„ Python ä»£ç ï¼‰                                â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”‚ åˆ¶ä½œèœå“                                            â”‚
â”‚     â–¼                                                    â”‚
â”‚  æœåŠ¡å‘˜ï¼ˆAPIï¼‰                                           â”‚
â”‚     â”‚                                                    â”‚
â”‚     â”‚ ç«¯èœä¸Šæ¡Œï¼š"æ‚¨çš„å®«ä¿é¸¡ä¸å¥½äº†"                        â”‚
â”‚     â–¼                                                    â”‚
â”‚  é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**FastAPI å°±æ˜¯è¿™ä¸ªæœåŠ¡å‘˜**ï¼Œå®ƒï¼š
- æ¥æ”¶ç”¨æˆ·çš„è¯·æ±‚ï¼ˆç‚¹èœï¼‰
- è°ƒç”¨ä½ çš„ä»£ç ï¼ˆå‘Šè¯‰å¨æˆ¿åšä»€ä¹ˆï¼‰
- è¿”å›ç»“æœï¼ˆæŠŠèœç«¯ç»™ç”¨æˆ·ï¼‰

**HTTP è¯·æ±‚å’Œå“åº”**

HTTP æ˜¯äº’è”ç½‘ä¸Šçš„"å¿«é€’åè®®"ï¼š

| éƒ¨åˆ† | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| **æ–¹æ³•** | è¦åšä»€ä¹ˆ | `GET`ï¼ˆè·å–ï¼‰ã€`POST`ï¼ˆæäº¤ï¼‰ |
| **è·¯å¾„** | è¦è®¿é—®å“ªé‡Œ | `/`ã€`/stream`ã€`/ag-ui` |
| **è¯·æ±‚ä½“** | æºå¸¦çš„æ•°æ® | `{"question": "åŒ—äº¬å¤©æ°”"}` |
| **å“åº”ä½“** | è¿”å›çš„æ•°æ® | `{"answer": "æ™´å¤©"}` |

---

### FastAPI åœ¨æœ¬é¡¹ç›®ä¸­çš„ä½¿ç”¨

#### æŸ¥çœ‹ agent.py ä¸­çš„ FastAPI

```python
from fastapi import FastAPI

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
app = FastAPI()

# å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼ˆè·¯ç”±ï¼‰
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    # è¿™é‡Œæ˜¯ä½ çš„ä¸šåŠ¡é€»è¾‘
    return QueryResponse(answer=result)
```

#### é€è¡Œè§£æ

**1. å¯¼å…¥ FastAPI**

```python
from fastapi import FastAPI
```

**ä½œç”¨**ï¼šä» fastapi åº“å¯¼å…¥ `FastAPI` ç±»ã€‚

**2. åˆ›å»ºåº”ç”¨å®ä¾‹**

```python
app = FastAPI()
```

**ä½œç”¨**ï¼šåˆ›å»ºä¸€ä¸ª FastAPI åº”ç”¨å¯¹è±¡ï¼Œå‘½åä¸º `app`ã€‚

**ä¸ºä»€ä¹ˆå« `app`ï¼Ÿ**
- è¿™æ˜¯çº¦å®šä¿—æˆçš„å‘½åæ–¹å¼
- å¹³å°ä¼šè‡ªåŠ¨è¯†åˆ« `agent.py` ä¸­çš„ `app` å¯¹è±¡æ¥å¯åŠ¨æœåŠ¡

**3. å®šä¹‰æ¥å£ï¼ˆè£…é¥°å™¨ï¼‰**

```python
@app.post("/")
```

**è§£é‡Š**ï¼š
- `@app`ï¼šä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ FastAPI åº”ç”¨
- `.post("/")`ï¼šå®šä¹‰ä¸€ä¸ª POST è¯·æ±‚æ¥å£ï¼Œè·¯å¾„æ˜¯ `/`

**è£…é¥°å™¨çš„ä½œç”¨**ï¼š

```
æŠŠä¸€ä¸ªæ™®é€šçš„ Python å‡½æ•°å˜æˆä¸€ä¸ªå¯ä»¥æ¥æ”¶ç½‘ç»œè¯·æ±‚çš„ API æ¥å£

æ™®é€šå‡½æ•°ï¼šquery(req) â†’ è¿”å›ç»“æœ
            â†“
    åŠ ä¸Š @app.post("/")
API æ¥å£ï¼šHTTP POST / â†’ query(req) â†’ è¿”å› HTTP å“åº”
```

**4. è¯·æ±‚å’Œå“åº”ç±»å‹**

```python
async def query(req: QueryRequest) -> QueryResponse:
```

| éƒ¨åˆ† | ç±»å‹ | ä½œç”¨ |
|------|------|------|
| `req` | `QueryRequest` | æ¥æ”¶è¯·æ±‚çš„æ ¼å¼ |
| `-> QueryResponse` | `QueryResponse` | è¿”å›å“åº”çš„æ ¼å¼ |

**æŸ¥çœ‹ QueryRequest çš„å®šä¹‰**ï¼š

```python
class QueryRequest(BaseModel):
    question: str
    chat_history: Optional[list] = None
```

è¿™æ„å‘³ç€ï¼šå®¢æˆ·ç«¯å¿…é¡»å‘é€åŒ…å« `question` å­—æ®µçš„ JSON æ•°æ®ã€‚

#### FastAPI åœ¨é¡¹ç›®ä¸­çš„å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·å‘é€ HTTP è¯·æ±‚                                           â”‚
â”‚  POST http://localhost:8000/                                    â”‚
â”‚  Body: {"question": "åŒ—äº¬å¤©æ°”"}                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. FastAPI æ¥æ”¶è¯·æ±‚                                             â”‚
â”‚  - éªŒè¯è¯·æ±‚æ ¼å¼ï¼ˆæ˜¯å¦åŒ…å« questionï¼‰                              â”‚
â”‚  - è§£æ JSON æ•°æ®                                               â”‚
â”‚  - åˆ›å»º QueryRequest å¯¹è±¡                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è°ƒç”¨ query å‡½æ•°                                              â”‚
â”‚  async def query(req: QueryRequest) -> QueryResponse:           â”‚
â”‚      # è¿™é‡Œæ˜¯ä½ çš„ä¸šåŠ¡é€»è¾‘                                        â”‚
â”‚      result = await agent_loop(...)                             â”‚
â”‚      return QueryResponse(answer=result)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. FastAPI åŒ…è£…å“åº”                                             â”‚
â”‚  - å°† QueryResponse å¯¹è±¡è½¬æ¢ä¸º JSON                             â”‚
â”‚  - è®¾ç½® HTTP çŠ¶æ€ç ï¼ˆ200 OKï¼‰                                   â”‚
â”‚  - æ·»åŠ å“åº”å¤´ï¼ˆContent-Type: application/jsonï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è¿”å› HTTP å“åº”ç»™ç”¨æˆ·                                         â”‚
â”‚  Status: 200 OK                                                 â”‚
â”‚  Body: {"answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—"}                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æœ¬é¡¹ç›®ä¸­çš„ä¸‰ä¸ªæ¥å£

**1. æ™®é€šè¯·æ±‚æ¥å£ï¼ˆ`POST /`ï¼‰**

```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    result = ""
    async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
        if chunk.type == "tool_call" or chunk.type == "tool_call_result":
            result = ""
        elif chunk.type == "text" and chunk.content:
            result += chunk.content
    return QueryResponse(answer=result)
```

**ç‰¹ç‚¹**ï¼š
- ç­‰å¾…å®Œæ•´ç­”æ¡ˆç”Ÿæˆåä¸€æ¬¡æ€§è¿”å›
- é€‚åˆéœ€è¦å®Œæ•´ç»“æœçš„åœºæ™¯

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```bash
curl -X POST "http://localhost:8000/" \
  -H "Content-Type: application/json" \
  -d '{"question": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}'
```

**å“åº”**ï¼š
```json
{
  "answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"
}
```

**2. æµå¼è¯·æ±‚æ¥å£ï¼ˆ`POST /stream`ï¼‰**

```python
@app.post("/stream")
async def stream(req: QueryRequest) -> StreamingResponse:
    async def stream_response():
        async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
            if chunk.type == "text" and chunk.content:
                data = {"answer": chunk.content}
                yield f"data: {json.dumps(data, ensure_ascii=False)}\n\n"

    return StreamingResponse(stream_response(), media_type="text/event-stream")
```

**ç‰¹ç‚¹**ï¼š
- å®æ—¶å‘é€ç”Ÿæˆçš„æ–‡æœ¬ç‰‡æ®µ
- é€‚åˆé•¿ç­”æ¡ˆæˆ–å¤æ‚æ¨ç†
- ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰åè®®

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```bash
curl -N -X POST "http://localhost:8000/stream" \
  -H "Content-Type: application/json" \
  -d '{"question": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"}'
```

**å“åº”**ï¼š
```
data: {"answer": "åŒ—äº¬"}

data: {"answer": "ä»Šå¤©"}

data: {"answer": "å¤©æ°”"}

data: {"answer": "æ™´æœ—"}
```

**3. AG-UI åè®®æ¥å£ï¼ˆ`POST /ag-ui`ï¼‰**

```python
@app.post("/ag-ui")
async def ag_ui(run_agent_input: RunAgentInput) -> StreamingResponse:
    messages = to_openai_messages(run_agent_input.messages)
    async def stream_response():
        async for event in stream_agui_events(
            chunks=agent_loop(messages, [web_search, get_weather]),
            run_agent_input=run_agent_input,
        ):
            yield to_sse_data(event)
    return StreamingResponse(stream_response(), media_type="text/event-stream")
```

**ç‰¹ç‚¹**ï¼š
- ç”¨äº LangStudio è°ƒè¯•é¢æ¿
- æ”¯æŒå¤æ‚çš„äº¤äº’å¼å¯¹è¯

---

### FastAPI çš„è‡ªåŠ¨æ–‡æ¡£åŠŸèƒ½

#### å¯åŠ¨æœåŠ¡åè®¿é—®æ–‡æ¡£

```bash
python agent.py
```

æœåŠ¡å¯åŠ¨åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€ï¼š

| æ–‡æ¡£ç±»å‹ | åœ°å€ | ç”¨é€” |
|---------|------|------|
| Swagger UI | `http://localhost:8000/docs` | äº¤äº’å¼ API æ–‡æ¡£ï¼Œå¯ç›´æ¥æµ‹è¯• |
| ReDoc | `http://localhost:8000/redoc` | æ›´ç¾è§‚çš„æ–‡æ¡£ç•Œé¢ |

#### Swagger UI ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI è‡ªåŠ¨æ–‡æ¡£ç•Œé¢                                     â”‚
â”‚                                                           â”‚
â”‚  POST /                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Request Body:                                   â”‚    â”‚
â”‚  â”‚ {                                               â”‚    â”‚
â”‚  â”‚   "question": "åŒ—äº¬å¤©æ°”"                        â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  [Try it out]  [Execute]                                  â”‚
â”‚                                                           â”‚
â”‚  Response Body:                                           â”‚
â”‚  {                                                       â”‚
â”‚    "answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—"                           â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- ä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™æ–‡æ¡£
- æ–‡æ¡£ä¸ä»£ç ä¿æŒåŒæ­¥
- å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯• API

#### FastAPI vs å…¶ä»–æ¡†æ¶

| ç‰¹æ€§ | FastAPI | Flask | Django |
|------|---------|-------|--------|
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| æ˜“ç”¨æ€§ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| è‡ªåŠ¨æ–‡æ¡£ | âœ… | âŒ | éœ€è¦æ’ä»¶ |
| ç±»å‹æç¤º | âœ… | âŒ | éƒ¨åˆ† |
| å¼‚æ­¥æ”¯æŒ | âœ… | éœ€è¦æ’ä»¶ | éƒ¨åˆ† |

---

## æ·±åº¦è§£æ

### Q7: å¼‚æ­¥ç¼–ç¨‹ï¼ˆasync/awaitï¼‰åœ¨è¿™ä¸ªé¡¹ç›®ä¸­èµ·ä»€ä¹ˆä½œç”¨ï¼Ÿ

#### ç­”æ¡ˆï¼šæé«˜æ€§èƒ½ï¼Œè®©ç¨‹åºåœ¨ç­‰å¾…æ—¶ä¹Ÿèƒ½å¤„ç†å…¶ä»–ä»»åŠ¡

#### ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹ï¼Ÿ

**åŒæ­¥ vs å¼‚æ­¥**çš„å¯¹æ¯”ï¼š

```
åŒæ­¥ï¼ˆBlockingï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯·æ±‚1ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  è¯·æ±‚2ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  è¯·æ±‚3ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  æ€»è€—æ—¶ï¼š9 ç§’                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼‚æ­¥ï¼ˆNon-blockingï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯·æ±‚1ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰                          â”‚
â”‚  è¯·æ±‚2ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰â† åŒæ—¶è¿›è¡Œ                â”‚
â”‚  è¯·æ±‚3ï¼šè°ƒç”¨ LLM APIï¼ˆç­‰å¾… 3 ç§’ï¼‰â† åŒæ—¶è¿›è¡Œ                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”     â”‚
â”‚  æ€»è€—æ—¶ï¼š3 ç§’ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### async/await çš„ä½œç”¨

```python
# åŒæ­¥æ–¹å¼
def query():
    result = call_llm_api()  # é˜»å¡ç­‰å¾…ï¼Œæ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚
    return result

# å¼‚æ­¥æ–¹å¼
async def query():
    result = await call_llm_api()  # ä¸é˜»å¡ï¼Œå¯ä»¥å¤„ç†å…¶ä»–è¯·æ±‚
    return result
```

| å…³é”®å­— | ä½œç”¨ |
|--------|------|
| `async def` | å®šä¹‰å¼‚æ­¥å‡½æ•°ï¼Œè¿”å›åç¨‹å¯¹è±¡ |
| `await` | ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œä½†ä¸é˜»å¡å…¶ä»–ä»»åŠ¡ |

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨

**1. LLM API è°ƒç”¨**

`agent_loop.py:168-175`ï¼š

```python
# å¼‚æ­¥è°ƒç”¨ LLM API
stream = await client.chat.completions.create(
    messages=prompt_messages, **params
)

# æµå¼å¤„ç†å“åº”
async for chunk in stream:
    # å¤„ç†æ¯ä¸ªç‰‡æ®µ
    ...
```

**ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ï¼Ÿ**
- LLM API è°ƒç”¨éœ€è¦æ—¶é—´ï¼ˆé€šå¸¸å‡ ç§’ï¼‰
- ä½¿ç”¨ `await` å¯ä»¥åœ¨ç­‰å¾…æ—¶å¤„ç†å…¶ä»–ç”¨æˆ·è¯·æ±‚
- æé«˜æœåŠ¡å¹¶å‘èƒ½åŠ›

**2. å·¥å…·å‡½æ•°æ‰§è¡Œ**

`agent_loop.py:278-282`ï¼š

```python
# æ£€æŸ¥å‡½æ•°æ˜¯å¦æ˜¯å¼‚æ­¥çš„
if iscoroutinefunction(func):
    result = await func(**parsed_args)  # å¼‚æ­¥æ‰§è¡Œ
else:
    result = func(**parsed_args)  # åŒæ­¥æ‰§è¡Œ
```

**æ”¯æŒä¸¤ç§ç±»å‹çš„å·¥å…·**ï¼š
- **å¼‚æ­¥å·¥å…·**ï¼šä½¿ç”¨ `async def` å®šä¹‰ï¼Œé€‚åˆç½‘ç»œè¯·æ±‚
- **åŒæ­¥å·¥å…·**ï¼šä½¿ç”¨æ™®é€š `def` å®šä¹‰ï¼Œé€‚åˆç®€å•è®¡ç®—

**3. FastAPI æ¥å£**

`agent.py:98-105`ï¼š

```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    result = ""

    # å¼‚æ­¥éå† agent_loop çš„è¾“å‡º
    async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
        if chunk.type == "text" and chunk.content:
            result += chunk.content

    return QueryResponse(answer=result)
```

**FastAPI è‡ªåŠ¨æ”¯æŒå¼‚æ­¥**ï¼š
- ä½¿ç”¨ `async def` çš„æ¥å£å¯ä»¥è¢«å¹¶å‘å¤„ç†
- æé«˜æœåŠ¡çš„ååé‡

#### å¦‚æœä¸ä½¿ç”¨å¼‚æ­¥ä¼šæ€æ ·ï¼Ÿ

**åŒæ­¥ç‰ˆæœ¬çš„é—®é¢˜**ï¼š

```python
# âŒ åŒæ­¥ç‰ˆæœ¬
def query(req: QueryRequest) -> QueryResponse:
    result = ""

    # åŒæ­¥éå†ï¼Œé˜»å¡çº¿ç¨‹
    for chunk in agent_loop(...):  # â† é˜»å¡ç­‰å¾…
        result += chunk.content

    return QueryResponse(answer=result)
```

**é—®é¢˜**ï¼š
1. **æ€§èƒ½å·®**ï¼šä¸€ä¸ªè¯·æ±‚å ç”¨æ•´ä¸ªçº¿ç¨‹ï¼Œå…¶ä»–è¯·æ±‚å¿…é¡»ç­‰å¾…
2. **å¹¶å‘ä½**ï¼šæ— æ³•åŒæ—¶å¤„ç†å¤šä¸ªç”¨æˆ·
3. **èµ„æºæµªè´¹**ï¼šçº¿ç¨‹åœ¨ç­‰å¾… LLM å“åº”æ—¶é—²ç½®

**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

```
åœºæ™¯ï¼š100 ä¸ªç”¨æˆ·åŒæ—¶è¯·æ±‚

åŒæ­¥æ¨¡å¼ï¼š
- éœ€è¦ 100 ä¸ªçº¿ç¨‹
- æ¯ä¸ªçº¿ç¨‹ç­‰å¾… 3 ç§’
- æ€»è€—æ—¶ï¼š3 ç§’ï¼ˆå¦‚æœæœ‰ 100 ä¸ªçº¿ç¨‹ï¼‰æˆ– 300 ç§’ï¼ˆå•çº¿ç¨‹ï¼‰

å¼‚æ­¥æ¨¡å¼ï¼š
- åªéœ€è¦å°‘é‡çº¿ç¨‹ï¼ˆé€šå¸¸ 4-8 ä¸ªï¼‰
- æ‰€æœ‰è¯·æ±‚å¹¶å‘å¤„ç†
- æ€»è€—æ—¶ï¼š3 ç§’ï¼ˆæ‰€æœ‰è¯·æ±‚åŒæ—¶å®Œæˆï¼‰
```

#### å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ

| âœ… å¥½çš„åšæ³• | âŒ ä¸å¥½çš„åšæ³• |
|------------|-------------|
| åœ¨ I/O å¯†é›†å‹æ“ä½œä¸­ä½¿ç”¨å¼‚æ­¥ï¼ˆç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰ | åœ¨ CPU å¯†é›†å‹æ“ä½œä¸­ä½¿ç”¨å¼‚æ­¥ |
| ä½¿ç”¨ `async for` å¤„ç†æµå¼æ•°æ® | åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ |
| æ··åˆä½¿ç”¨å¼‚æ­¥å’ŒåŒæ­¥ä»£ç æ—¶æ˜ç¡®åŒºåˆ† | éšæ„æ··ç”¨å¯¼è‡´æ€§èƒ½ä¸‹é™ |

---

### Q8: `tool_calls_buffer` ä¸ºä»€ä¹ˆä½¿ç”¨å­—å…¸è€Œä¸æ˜¯åˆ—è¡¨ï¼Ÿ

#### ç­”æ¡ˆï¼šå­—å…¸å¯ä»¥æ­£ç¡®åŒºåˆ†å’Œç´¯ç§¯å¤šä¸ªå¹¶å‘å·¥å…·è°ƒç”¨

#### æŸ¥çœ‹ä»£ç 

`agent_loop.py:195-213`ï¼š

```python
tool_calls_buffer = {}  # â† ä½¿ç”¨å­—å…¸

async for chunk in stream:
    if chunk.tool_calls:
        for tc_chunk in chunk.tool_calls:
            idx = tc_chunk.index  # â† å·¥å…·è°ƒç”¨çš„ç´¢å¼•

            # åˆå§‹åŒ–è¯¥å·¥å…·è°ƒç”¨çš„ç¼“å†²åŒº
            if idx not in tool_calls_buffer:
                tool_calls_buffer[idx] = {
                    "id": tc_chunk.id,
                    "function": {
                        "name": tc_chunk.function.name,
                        "arguments": "",
                    },
                }

            # ç´¯ç§¯ arguments ç‰‡æ®µ
            if tc_chunk.function.arguments:
                tool_calls_buffer[idx]["function"]["arguments"] += (
                    tc_chunk.function.arguments
                )
```

#### ä¸ºä»€ä¹ˆéœ€è¦å­—å…¸ï¼Ÿ

**åœºæ™¯ï¼šLLM åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·**

```
LLM è¿”å›ï¼š
tool_calls: [
    {index: 0, name: "web_search", arguments: '{"query": "åŒ—äº¬å¤©æ°”"...'},
    {index: 1, name: "get_weather", arguments: '{"location": "ä¸Šæµ·"...'}
]
```

**æµå¼äº¤é”™è¿”å›**ï¼š

```
Chunk 1: index=0, arguments='{"query": "'
Chunk 2: index=1, arguments='{"location": "'
Chunk 3: index=0, arguments='åŒ—äº¬å¤©æ°”"}'
Chunk 4: index=1, arguments='ä¸Šæµ·"}'
```

#### ä½¿ç”¨å­—å…¸çš„æ­£ç¡®å¤„ç†

```python
tool_calls_buffer = {}

# Chunk 1: index=0
tool_calls_buffer[0] = {"function": {"arguments": '{"query': "'}}

# Chunk 2: index=1
tool_calls_buffer[1] = {"function": {"arguments": '{"location": "'}}

# Chunk 3: index=0
tool_calls_buffer[0]["function"]["arguments"] += 'åŒ—äº¬å¤©æ°”"}'
# ç»“æœ: tool_calls_buffer[0] = '{"query": "åŒ—äº¬å¤©æ°”"}'

# Chunk 4: index=1
tool_calls_buffer[1]["function"]["arguments"] += 'ä¸Šæµ·"}'
# ç»“æœ: tool_calls_buffer[1] = '{"location": "ä¸Šæµ·"}'
```

**æœ€ç»ˆç»“æœ**ï¼š
```python
{
    0: {"id": "call_1", "function": {"name": "web_search", "arguments": '{"query": "åŒ—äº¬å¤©æ°”"}'}},
    1: {"id": "call_2", "function": {"name": "get_weather", "arguments": '{"location": "ä¸Šæµ·"}'}}
}
```

#### å¦‚æœä½¿ç”¨åˆ—è¡¨ä¼šæ€æ ·ï¼Ÿ

```python
tool_calls_buffer = []  # â† é”™è¯¯ï¼šä½¿ç”¨åˆ—è¡¨

# Chunk 1: index=0
tool_calls_buffer.append({"function": {"arguments": '{"query': "'}})

# Chunk 2: index=1
tool_calls_buffer.append({"function": {"arguments": '{"location": "'}})

# Chunk 3: index=0
tool_calls_buffer.append({"function": {"arguments": 'åŒ—äº¬å¤©æ°”"}'})  # â† é—®é¢˜ï¼
# ç°åœ¨åˆ—è¡¨ä¸­æœ‰ 4 ä¸ªå…ƒç´ ï¼Œä½†ä¸çŸ¥é“å“ªä¸ªå±äºå“ªä¸ªå·¥å…·è°ƒç”¨

# Chunk 4: index=1
tool_calls_buffer.append({"function": {"arguments": 'ä¸Šæµ·"}'})  # â† é—®é¢˜ï¼
```

**é—®é¢˜**ï¼š
1. æ— æ³•åŒºåˆ†å“ªäº›ç‰‡æ®µå±äºå“ªä¸ªå·¥å…·è°ƒç”¨
2. éœ€è¦é¢å¤–çš„é€»è¾‘æ¥è¿½è¸ªå’ŒåŒ¹é…
3. å®¹æ˜“å‡ºé”™ï¼Œç‰¹åˆ«æ˜¯åœ¨å¹¶å‘è°ƒç”¨æ—¶

#### å­—å…¸ vs åˆ—è¡¨å¯¹æ¯”

| ç‰¹æ€§ | å­—å…¸ `tool_calls_buffer[idx]` | åˆ—è¡¨ `tool_calls_buffer.append()` |
|------|------------------------------|-----------------------------------|
| **åŒºåˆ†å·¥å…·è°ƒç”¨** | âœ… é€šè¿‡ç´¢å¼• `idx` åŒºåˆ† | âŒ æ— æ³•è‡ªåŠ¨åŒºåˆ† |
| **ç´¯ç§¯ç‰‡æ®µ** | âœ… ç›´æ¥è¿½åŠ åˆ°å¯¹åº”ç´¢å¼• | âŒ éœ€è¦é¢å¤–åŒ¹é…é€»è¾‘ |
| **å¤„ç†å¹¶å‘** | âœ… æ”¯æŒå¤šä¸ªå·¥å…·å¹¶å‘è°ƒç”¨ | âŒ å®¹æ˜“æ··æ·† |
| **ä»£ç å¤æ‚åº¦** | âœ… ç®€å•æ¸…æ™° | âŒ éœ€è¦å¤æ‚é€»è¾‘ |

#### æ€»ç»“

ä½¿ç”¨å­—å…¸çš„åŸå› ï¼š
1. **é”®æ˜¯å”¯ä¸€çš„**ï¼š`idx` å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå·¥å…·è°ƒç”¨
2. **è‡ªåŠ¨åŒºåˆ†**ï¼šä¸åŒå·¥å…·è°ƒç”¨çš„ç‰‡æ®µä¸ä¼šæ··æ·†
3. **æ˜“äºè®¿é—®**ï¼šé€šè¿‡ `tool_calls_buffer[idx]` ç›´æ¥è®¿é—®
4. **æ”¯æŒå¹¶å‘**ï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå·¥å…·è°ƒç”¨

---

### Q9: ä¸ºä»€ä¹ˆæµå¼å“åº”ä½¿ç”¨ `yield` è€Œä¸æ˜¯ `return`ï¼Ÿ

#### ç­”æ¡ˆï¼š`yield` é€ä¸ªè¿”å›æ•°æ®ï¼Œ`return` ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®

#### yield vs return çš„åŒºåˆ«

**return çš„è¡Œä¸º**ï¼š

```python
def get_numbers():
    numbers = [1, 2, 3, 4, 5]
    return numbers  # â† ä¸€æ¬¡æ€§è¿”å›æ•´ä¸ªåˆ—è¡¨

result = get_numbers()
# result = [1, 2, 3, 4, 5]
```

**ç‰¹ç‚¹**ï¼š
- å¿…é¡»ç­‰å¾…æ‰€æœ‰æ•°æ®ç”Ÿæˆå®Œæˆ
- ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®
- å ç”¨æ›´å¤šå†…å­˜

**yield çš„è¡Œä¸º**ï¼š

```python
def get_numbers():
    for i in range(1, 6):
        yield i  # â† é€ä¸ªè¿”å›

result = get_numbers()
# result æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡

for num in result:
    print(num)
# è¾“å‡ºï¼š
# 1
# 2
# 3
# 4
# 5
```

**ç‰¹ç‚¹**ï¼š
- é€ä¸ªç”Ÿæˆæ•°æ®
- ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®å®Œæˆ
- èŠ‚çœå†…å­˜

#### ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰ï¼Ÿ

**ç”Ÿæˆå™¨**æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿­ä»£å™¨ï¼Œä½¿ç”¨ `yield` å…³é”®å­—åˆ›å»ºã€‚

```
æ™®é€šå‡½æ•°ï¼š
è°ƒç”¨ â†’ æ‰§è¡Œ â†’ è¿”å›ç»“æœ â†’ å‡½æ•°ç»“æŸ
         â†“
    ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®

ç”Ÿæˆå™¨å‡½æ•°ï¼š
è°ƒç”¨ â†’ è¿”å›ç”Ÿæˆå™¨å¯¹è±¡
         â†“
    æ¯æ¬¡è°ƒç”¨ next() â†’ æ‰§è¡Œåˆ° yield â†’ è¿”å›å€¼ â†’ æš‚åœ
         â†“
    å†æ¬¡è°ƒç”¨ next() â†’ ä»æš‚åœå¤„ç»§ç»­ â†’ æ‰§è¡Œåˆ° yield â†’ è¿”å›å€¼ â†’ æš‚åœ
         â†“
    ... é‡å¤ç›´åˆ°å‡½æ•°ç»“æŸ
```

#### åœ¨æµå¼å“åº”ä¸­çš„åº”ç”¨

**æ™®é€šæ¥å£ï¼ˆä½¿ç”¨ returnï¼‰**

`agent.py:98-105`ï¼š

```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    result = ""

    # ç­‰å¾…æ‰€æœ‰å†…å®¹ç”Ÿæˆå®Œæˆ
    async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
        if chunk.type == "text" and chunk.content:
            result += chunk.content

    # ä¸€æ¬¡æ€§è¿”å›å®Œæ•´ç­”æ¡ˆ
    return QueryResponse(answer=result)
```

**æµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ ç­‰å¾… 3 ç§’ â†’ è¿”å›å®Œæ•´ç­”æ¡ˆ
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**æµå¼æ¥å£ï¼ˆä½¿ç”¨ yieldï¼‰**

`agent.py:107-126`ï¼š

```python
@app.post("/stream")
async def stream(req: QueryRequest) -> StreamingResponse:
    async def stream_response():
        # é€ä¸ªå‘é€æ•°æ®ç‰‡æ®µ
        async for chunk in agent_loop(req.to_messages(), [web_search, get_weather]):
            if chunk.type == "text" and chunk.content:
                data = {"answer": chunk.content}
                yield f"data: {json.dumps(data, ensure_ascii=False)}\n\n"

    return StreamingResponse(stream_response(), media_type="text/event-stream")
```

**æµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ ç«‹å³è¿”å› "åŒ—äº¬"
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â†’ 0.5ç§’åè¿”å› "ä»Šå¤©"
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â†’ 1ç§’åè¿”å› "å¤©æ°”"
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â†’ 1.5ç§’åè¿”å› "æ™´æœ—"
```

#### ä¸ºä»€ä¹ˆæµå¼å“åº”éœ€è¦ yieldï¼Ÿ

**1. å®æ—¶æ€§**

```
ä¸ä½¿ç”¨ yieldï¼ˆreturnï¼‰ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç­‰å¾… 3 ç§’ â†’ çœ‹åˆ°å®Œæ•´ç­”æ¡ˆ

ä½¿ç”¨ yieldï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç«‹å³çœ‹åˆ° "åŒ—äº¬" â†’ çœ‹åˆ° "ä»Šå¤©" â†’ çœ‹åˆ° "å¤©æ°”" â†’ çœ‹åˆ° "æ™´æœ—"
```

**ç”¨æˆ·ä½“éªŒå·®å¼‚**ï¼š
- **return**ï¼šç”¨æˆ·æ„Ÿè§‰"å¡ä½äº†"ï¼Œä¸çŸ¥é“æ˜¯å¦åœ¨å·¥ä½œ
- **yield**ï¼šç”¨æˆ·çœ‹åˆ°ç­”æ¡ˆæ­£åœ¨ç”Ÿæˆï¼Œæ„Ÿè§‰æ›´æµç•…

**2. å†…å­˜æ•ˆç‡**

```python
# return æ–¹å¼ï¼šéœ€è¦å­˜å‚¨æ‰€æœ‰æ•°æ®
def generate_large_data():
    data = []
    for i in range(1000000):
        data.append(i * 2)  # â† å ç”¨å¤§é‡å†…å­˜
    return data

# yield æ–¹å¼ï¼šé€ä¸ªç”Ÿæˆï¼Œä¸å ç”¨å†…å­˜
def generate_large_data():
    for i in range(1000000):
        yield i * 2  # â† æ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªå€¼
```

**3. æ”¯æŒæ— é™æµ**

```python
# return æ–¹å¼ï¼šæ— æ³•å¤„ç†æ— é™æ•°æ®
def infinite_stream():
    data = []
    while True:  # â† æ°¸è¿œä¸ä¼šç»“æŸ
        data.append(get_next_value())
    return data  # â† æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ

# yield æ–¹å¼ï¼šå¯ä»¥å¤„ç†æ— é™æµ
def infinite_stream():
    while True:
        yield get_next_value()  # â† å¯ä»¥æŒç»­ç”Ÿæˆ
```

#### StreamingResponse çš„å·¥ä½œåŸç†

```python
from fastapi.responses import StreamingResponse

@app.post("/stream")
async def stream():
    async def generate():
        for i in range(5):
            yield f"chunk {i}\n"
            await asyncio.sleep(0.5)  # æ¨¡æ‹Ÿå»¶è¿Ÿ

    return StreamingResponse(generate(), media_type="text/plain")
```

**StreamingResponse ä¼š**ï¼š
1. è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•° `generate()`
2. æ¯æ¬¡ `yield` æ—¶ï¼Œç«‹å³å‘é€æ•°æ®
3. ä¿æŒè¿æ¥æ‰“å¼€ï¼Œç›´åˆ°ç”Ÿæˆå™¨ç»“æŸ

#### å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | return | yield |
|------|--------|-------|
| **è¿”å›æ–¹å¼** | ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ® | é€ä¸ªè¿”å›æ•°æ® |
| **ç­‰å¾…æ—¶é—´** | å¿…é¡»ç­‰å¾…æ‰€æœ‰æ•°æ®å®Œæˆ | ç«‹å³è¿”å›ç¬¬ä¸€ä¸ªæ•°æ® |
| **å†…å­˜å ç”¨** | é«˜ï¼ˆå­˜å‚¨æ‰€æœ‰æ•°æ®ï¼‰ | ä½ï¼ˆé€ä¸ªç”Ÿæˆï¼‰ |
| **å®æ—¶æ€§** | å·® | å¥½ |
| **é€‚ç”¨åœºæ™¯** | å°æ•°æ®ã€éœ€è¦å®Œæ•´ç»“æœ | å¤§æ•°æ®ã€æµå¼ä¼ è¾“ |

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨

| æ¥å£ | ä½¿ç”¨æ–¹å¼ | åŸå›  |
|------|---------|------|
| `POST /` | `return` | è¿”å›å®Œæ•´ç­”æ¡ˆï¼Œæ ¼å¼ç®€å• |
| `POST /stream` | `yield` | å®æ—¶æµå¼ä¼ è¾“ï¼Œæå‡ç”¨æˆ·ä½“éªŒ |
| `POST /ag-ui` | `yield` | å¤æ‚äº‹ä»¶æµï¼Œéœ€è¦å®æ—¶æ›´æ–° |

---

## åŸºç¡€çŸ¥è¯†æ‰©å±•

### Q10: ä»€ä¹ˆæ˜¯ JSONï¼Ÿä¸ºä»€ä¹ˆåœ¨é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨ JSONï¼Ÿ

#### ç­”æ¡ˆï¼šJSON æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œæ˜“äºäººé˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆ

#### ä»€ä¹ˆæ˜¯ JSONï¼Ÿ

**JSON**ï¼ˆJavaScript Object Notationï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚

**JSON çš„ç‰¹ç‚¹**ï¼š
- ğŸ“ æ˜“äºé˜…è¯»å’Œç¼–å†™
- ğŸ¤– æ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆ
- ğŸŒ ç‹¬ç«‹äºç¼–ç¨‹è¯­è¨€
- ğŸ“¦ åŸºäºæ–‡æœ¬ï¼Œä½“ç§¯å°

#### JSON çš„åŸºæœ¬ç»“æ„

**å¯¹è±¡**ï¼ˆObjectï¼‰ï¼š
```json
{
  "name": "å¼ ä¸‰",
  "age": 25,
  "city": "åŒ—äº¬"
}
```

**æ•°ç»„**ï¼ˆArrayï¼‰ï¼š
```json
[
  "è‹¹æœ",
  "é¦™è•‰",
  "æ©™å­"
]
```

**åµŒå¥—ç»“æ„**ï¼š
```json
{
  "user": {
    "name": "æå››",
    "age": 30
  },
  "hobbies": ["é˜…è¯»", "æ¸¸æ³³", "ç¼–ç¨‹"]
}
```

#### JSON æ•°æ®ç±»å‹

| JSON ç±»å‹ | Python ç±»å‹ | ç¤ºä¾‹ |
|-----------|------------|------|
| `string` | `str` | `"ä½ å¥½"` |
| `number` | `int` / `float` | `42`, `3.14` |
| `boolean` | `bool` | `true`, `false` |
| `null` | `None` | `null` |
| `array` | `list` | `[1, 2, 3]` |
| `object` | `dict` | `{"key": "value"}` |

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨

**1. question.jsonl æ–‡ä»¶**

```json
{"id": 0, "question": "ä¸€ä½æ¬§æ´²å­¦è€…çš„æŸé¡¹å¼€æºç¡¬ä»¶é¡¹ç›®..."}
{"id": 1, "question": "Who is the author of the article..."}
```

**2. API è¯·æ±‚æ ¼å¼**

```json
{
  "question": "åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"
}
```

**3. API å“åº”æ ¼å¼**

```json
{
  "answer": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨ 10â„ƒ åˆ° 20â„ƒ ä¹‹é—´ã€‚"
}
```

**4. å·¥å…·è°ƒç”¨å‚æ•°**

```json
{
  "name": "web_search",
  "arguments": "{\"query\": \"åŒ—äº¬å¤©æ°”\", \"top_k\": 5}"
}
```

#### ä¸ºä»€ä¹ˆé€‰æ‹© JSONï¼Ÿ

| ç‰¹æ€§ | JSON | XML | YAML |
|------|------|-----|------|
| **å¯è¯»æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **ä½“ç§¯** | â­â­â­â­â­ | â­â­ | â­â­â­â­ |
| **è§£æé€Ÿåº¦** | â­â­â­â­â­ | â­â­â­ | â­â­â­ |
| **è¯­è¨€æ”¯æŒ** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ³¨é‡Šæ”¯æŒ** | âŒ | âœ… | âœ… |

#### JSON vs XML

**XML ç¤ºä¾‹**ï¼š
```xml
<person>
  <name>å¼ ä¸‰</name>
  <age>25</age>
  <city>åŒ—äº¬</city>
</person>
```

**JSON ç¤ºä¾‹**ï¼š
```json
{
  "name": "å¼ ä¸‰",
  "age": 25,
  "city": "åŒ—äº¬"
}
```

**JSON çš„ä¼˜åŠ¿**ï¼š
- æ›´ç®€æ´ï¼Œä½“ç§¯æ›´å°
- è§£æé€Ÿåº¦æ›´å¿«
- æ›´ç¬¦åˆç°ä»£ Web å¼€å‘ä¹ æƒ¯

#### Python ä¸­ä½¿ç”¨ JSON

**è§£æ JSON å­—ç¬¦ä¸²**ï¼š
```python
import json

json_str = '{"name": "å¼ ä¸‰", "age": 25}'
data = json.loads(json_str)
print(data["name"])  # è¾“å‡ºï¼šå¼ ä¸‰
```

**ç”Ÿæˆ JSON å­—ç¬¦ä¸²**ï¼š
```python
import json

data = {"name": "æå››", "age": 30}
json_str = json.dumps(data, ensure_ascii=False)
print(json_str)  # è¾“å‡ºï¼š{"name": "æå››", "age": 30}
```

---

### Q11: ä»€ä¹ˆæ˜¯ç¯å¢ƒå˜é‡ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦é…ç½® `DASHSCOPE_API_KEY`ï¼Ÿ

#### ç­”æ¡ˆï¼šç¯å¢ƒå˜é‡æ˜¯å­˜å‚¨åœ¨æ“ä½œç³»ç»Ÿä¸­çš„åŠ¨æ€å€¼ï¼Œç”¨äºé…ç½®åº”ç”¨ç¨‹åºçš„è¿è¡Œç¯å¢ƒ

#### ä»€ä¹ˆæ˜¯ç¯å¢ƒå˜é‡ï¼Ÿ

**ç¯å¢ƒå˜é‡**æ˜¯å­˜å‚¨åœ¨æ“ä½œç³»ç»Ÿä¸­çš„é”®å€¼å¯¹ï¼Œç”¨äºå­˜å‚¨é…ç½®ä¿¡æ¯ã€‚

**ç‰¹ç‚¹**ï¼š
- ğŸ”’ å®‰å…¨ï¼šæ•æ„Ÿä¿¡æ¯ä¸ä¼šæš´éœ²åœ¨ä»£ç ä¸­
- ğŸ”„ çµæ´»ï¼šä¸åŒç¯å¢ƒå¯ä»¥ä½¿ç”¨ä¸åŒçš„é…ç½®
- ğŸŒ é€šç”¨ï¼šå‡ ä¹æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒ

#### å¸¸è§çš„ç¯å¢ƒå˜é‡

| å˜é‡å | ç”¨é€” | ç¤ºä¾‹ |
|--------|------|------|
| `PATH` | ç³»ç»Ÿå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ | `/usr/bin:/bin` |
| `HOME` | ç”¨æˆ·ä¸»ç›®å½• | `/home/user` |
| `LANG` | ç³»ç»Ÿè¯­è¨€è®¾ç½® | `zh_CN.UTF-8` |
| `DASHSCOPE_API_KEY` | é˜¿é‡Œäº‘ç™¾ç‚¼ API å¯†é’¥ | `sk-xxx...` |

#### ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ

**âŒ ä¸å¥½çš„åšæ³•ï¼šç¡¬ç¼–ç **

```python
# ç›´æ¥å†™åœ¨ä»£ç é‡Œ
API_KEY = "sk-1234567890abcdef"  # â† å±é™©ï¼ä¼šæš´éœ²ç»™æ‰€æœ‰äºº

def call_llm():
    client = OpenAI(api_key=API_KEY)  # â† å¯†é’¥æ³„éœ²
```

**é—®é¢˜**ï¼š
- âŒ ä»£ç ä¸Šä¼ åˆ° GitHub åï¼Œå¯†é’¥ä¼šè¢«å…¬å¼€
- âŒ ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ä½ çš„ API å¯†é’¥
- âŒ æ— æ³•åœ¨ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥

**âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡**

```python
import os
from openai import AsyncOpenAI

# ä»ç¯å¢ƒå˜é‡è¯»å–
API_KEY = os.getenv("DASHSCOPE_API_KEY")

def call_llm():
    client = AsyncOpenAI(api_key=API_KEY)  # â† å®‰å…¨
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯†é’¥ä¸ä¼šæš´éœ²åœ¨ä»£ç ä¸­
- âœ… å¯ä»¥åœ¨ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥
- âœ… ä¾¿äºç®¡ç†å’Œæ›´æ–°

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„ä½¿ç”¨

**1. é…ç½® .env æ–‡ä»¶**

```env
# .env
DASHSCOPE_API_KEY=sk-your-api-key-here
SERPAPI_API_KEY=your-serpapi-key
BING_API_KEY=your-bing-key
```

**2. åŠ è½½ç¯å¢ƒå˜é‡**

`agent.py:23-40`ï¼š

```python
def _load_env_from_dotenv():
    try:
        here = Path(__file__).resolve().parent
        candidates = [here / ".env", Path.cwd() / ".env"]
        seen = set()
        for p in candidates:
            if not p.exists():
                continue
            if str(p) in seen:
                continue
            seen.add(str(p))
            with open(p, "r", encoding="utf-8") as f:
                for line in f:
                    s = line.strip()
                    if not s or s.startswith("#") or "=" not in s:
                        continue
                    k, v = s.split("=", 1)
                    k = k.strip()
                    v = v.strip().strip('"').strip("'")
                    if k and v and k not in os.environ:
                        os.environ[k] = v
    except Exception:
        pass

_load_env_from_dotenv()
```

**3. ä½¿ç”¨ç¯å¢ƒå˜é‡**

`agent_loop.py:115-120`ï¼š

```python
import os

assert os.getenv("DASHSCOPE_API_KEY"), "DASHSCOPE_API_KEY is not set"

client = AsyncOpenAI(
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    api_key=os.getenv("DASHSCOPE_API_KEY"),
)
```

#### å¦‚ä½•è®¾ç½®ç¯å¢ƒå˜é‡ï¼Ÿ

**æ–¹æ³• 1ï¼šä½¿ç”¨ .env æ–‡ä»¶**

```env
DASHSCOPE_API_KEY=sk-xxx
```

**æ–¹æ³• 2ï¼šåœ¨å‘½ä»¤è¡Œè®¾ç½®**

```bash
# Windows
set DASHSCOPE_API_KEY=sk-xxx

# Linux/macOS
export DASHSCOPE_API_KEY=sk-xxx
```

**æ–¹æ³• 3ï¼šåœ¨ Python ä¸­è®¾ç½®**

```python
import os
os.environ["DASHSCOPE_API_KEY"] = "sk-xxx"
```

#### .env æ–‡ä»¶çš„æœ€ä½³å®è·µ

**åˆ›å»º .gitignore**ï¼š

```gitignore
# .gitignore
.env
```

**ä½œç”¨**ï¼šé˜²æ­¢ .env æ–‡ä»¶è¢«æäº¤åˆ° Gitï¼Œé¿å…å¯†é’¥æ³„éœ²ã€‚

**åˆ›å»º .env.example**ï¼š

```env
# .env.example
DASHSCOPE_API_KEY=your-api-key-here
SERPAPI_API_KEY=your-serpapi-key
BING_API_KEY=your-bing-key
```

**ä½œç”¨**ï¼šæä¾›ç¤ºä¾‹é…ç½®ï¼Œå‘Šè¯‰ç”¨æˆ·éœ€è¦é…ç½®å“ªäº›ç¯å¢ƒå˜é‡ã€‚

---

### Q12: ä»€ä¹ˆæ˜¯ `BaseModel`ï¼ŸFastAPI å¦‚ä½•ç”¨å®ƒéªŒè¯æ•°æ®ï¼Ÿ

#### ç­”æ¡ˆï¼š`BaseModel` æ˜¯ Pydantic æä¾›çš„åŸºç±»ï¼Œç”¨äºå®šä¹‰æ•°æ®æ¨¡å‹å’Œè‡ªåŠ¨éªŒè¯

#### ä»€ä¹ˆæ˜¯ BaseModelï¼Ÿ

**BaseModel** æ˜¯ Pydantic åº“æä¾›çš„åŸºç±»ï¼Œç”¨äºå®šä¹‰æ•°æ®æ¨¡å‹ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ç±»å‹éªŒè¯
- âœ… è‡ªåŠ¨æ•°æ®è½¬æ¢
- âœ… ç”Ÿæˆ JSON Schema
- âœ… æ”¯æŒ IDE è‡ªåŠ¨è¡¥å…¨

#### åœ¨æœ¬é¡¹ç›®ä¸­çš„åº”ç”¨

**å®šä¹‰è¯·æ±‚æ¨¡å‹**ï¼š

`agent.py:52-61`ï¼š

```python
from pydantic import BaseModel, ConfigDict

class QueryRequest(BaseModel):
    model_config = ConfigDict(
        extra="allow",
        json_schema_extra={
            "example": {"question": "What is the weather in Beijing today?"}
        },
    )

    question: str
    chat_history: Optional[list] = None

    def to_messages(self) -> list:
        if self.chat_history:
            return self.chat_history + [{"role": "user", "content": self.question}]
        else:
            return [
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä¸ªResearch Agentï¼Œéµå¾ªReActï¼šå½“éœ€è¦å¤–éƒ¨ä¿¡æ¯æˆ–è¯æ®æ—¶è°ƒç”¨ web_search å·¥å…·ï¼Œå¹¶åŸºäºæ£€ç´¢ç»“æœè¿›è¡Œå›ç­”ï¼›ç­”æ¡ˆå¿…é¡»ä¸ºçº¯æ–‡æœ¬ä¸”ä¸æé—®è¯­è¨€ä¸€è‡´ï¼›ä¸å¾—ç¡¬ç¼–ç ç­”æ¡ˆæˆ–è°ƒç”¨ç¬¬ä¸‰æ–¹AgentæœåŠ¡ã€‚",
                },
                {"role": "user", "content": self.question},
            ]
```

**å®šä¹‰å“åº”æ¨¡å‹**ï¼š

`agent.py:63-65`ï¼š

```python
class QueryResponse(BaseModel):
    answer: str
```

#### FastAPI å¦‚ä½•ä½¿ç”¨ BaseModelï¼Ÿ

**1. è‡ªåŠ¨éªŒè¯è¯·æ±‚æ•°æ®**

```python
@app.post("/")
async def query(req: QueryRequest) -> QueryResponse:
    # FastAPI è‡ªåŠ¨éªŒè¯ req çš„æ ¼å¼
    # å¦‚æœ question ç¼ºå¤±æˆ–ç±»å‹é”™è¯¯ï¼Œä¼šè¿”å› 422 é”™è¯¯
    return QueryResponse(answer=result)
```

**2. è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£**

```python
class QueryRequest(BaseModel):
    question: str  # â† ç±»å‹æç¤º
    chat_history: Optional[list] = None  # â† å¯é€‰å­—æ®µ
```

FastAPI ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
- è¯·æ±‚å‚æ•°è¯´æ˜
- æ•°æ®ç±»å‹è¯´æ˜
- å¿…å¡«/å¯é€‰å­—æ®µæ ‡è®°
- ç¤ºä¾‹æ•°æ®

#### æ•°æ®éªŒè¯ç¤ºä¾‹

**æ­£ç¡®çš„è¯·æ±‚**ï¼š

```json
{
  "question": "åŒ—äº¬å¤©æ°”"
}
```

âœ… FastAPI æ¥å—è¯·æ±‚ï¼ŒéªŒè¯é€šè¿‡

**é”™è¯¯çš„è¯·æ±‚**ï¼š

```json
{
  "name": "åŒ—äº¬å¤©æ°”"  # â† å­—æ®µåé”™è¯¯
}
```

âŒ FastAPI è¿”å› 422 é”™è¯¯ï¼š
```json
{
  "detail": [
    {
      "type": "missing",
      "loc": ["body", "question"],
      "msg": "Field required",
      "input": {"name": "åŒ—äº¬å¤©æ°”"}
    }
  ]
}
```

#### ç±»å‹æç¤ºçš„ä½œç”¨

```python
class QueryRequest(BaseModel):
    question: str  # â† å¿…é¡»æ˜¯å­—ç¬¦ä¸²
    chat_history: Optional[list] = None  # â† å¯é€‰ï¼Œå¿…é¡»æ˜¯åˆ—è¡¨æˆ– None
```

**éªŒè¯è§„åˆ™**ï¼š

| å­—æ®µ | ç±»å‹ | éªŒè¯è§„åˆ™ |
|------|------|---------|
| `question` | `str` | å¿…é¡»æä¾›ï¼Œå¿…é¡»æ˜¯å­—ç¬¦ä¸² |
| `chat_history` | `Optional[list]` | å¯é€‰ï¼Œå¿…é¡»æ˜¯åˆ—è¡¨æˆ– None |

**é”™è¯¯ç¤ºä¾‹**ï¼š

```json
{
  "question": 123  # â† æ•°å­—ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
}
```

âŒ éªŒè¯å¤±è´¥ï¼š`question` å¿…é¡»æ˜¯å­—ç¬¦ä¸²

#### é«˜çº§éªŒè¯

**æ·»åŠ éªŒè¯è§„åˆ™**ï¼š

```python
from pydantic import BaseModel, Field, field_validator

class QueryRequest(BaseModel):
    question: str = Field(..., min_length=1, max_length=1000)
    
    @field_validator('question')
    @classmethod
    def question_must_not_be_empty(cls, v):
        if not v.strip():
            raise ValueError('question cannot be empty')
        return v
```

**éªŒè¯è§„åˆ™**ï¼š
- `min_length=1`ï¼šæœ€å°‘ 1 ä¸ªå­—ç¬¦
- `max_length=1000`ï¼šæœ€å¤š 1000 ä¸ªå­—ç¬¦
- è‡ªå®šä¹‰éªŒè¯ï¼šä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²

#### BaseModel çš„ä¼˜åŠ¿

| ç‰¹æ€§ | ä½¿ç”¨ BaseModel | ä¸ä½¿ç”¨ BaseModel |
|------|---------------|-----------------|
| **ç±»å‹å®‰å…¨** | âœ… è‡ªåŠ¨éªŒè¯ | âŒ éœ€è¦æ‰‹åŠ¨éªŒè¯ |
| **æ–‡æ¡£ç”Ÿæˆ** | âœ… è‡ªåŠ¨ç”Ÿæˆ | âŒ éœ€è¦æ‰‹åŠ¨ç¼–å†™ |
| **IDE æ”¯æŒ** | âœ… è‡ªåŠ¨è¡¥å…¨ | âŒ æ— æç¤º |
| **é”™è¯¯å¤„ç†** | âœ… è‡ªåŠ¨è¿”å›é”™è¯¯ä¿¡æ¯ | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç† |

#### å®é™…ç¤ºä¾‹

**è¯·æ±‚éªŒè¯æµç¨‹**ï¼š

```
ç”¨æˆ·å‘é€è¯·æ±‚
    â†“
FastAPI æ¥æ”¶è¯·æ±‚
    â†“
è§£æ JSON æ•°æ®
    â†“
æ ¹æ® QueryRequest éªŒè¯
    â†“
éªŒè¯é€šè¿‡ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è°ƒç”¨ query å‡½æ•°
    â””â”€ å¦ â†’ è¿”å› 422 é”™è¯¯ï¼Œè¯´æ˜éªŒè¯å¤±è´¥åŸå› 
```

**é”™è¯¯å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "detail": [
    {
      "type": "string_too_short",
      "loc": ["body", "question"],
      "msg": "String should have at least 1 character",
      "input": ""
    }
  ]
}
```

---

## ğŸ¯ å­¦ä¹ è·¯å¾„å»ºè®®

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šç†è§£ ReAct æ¨¡å¼å’Œ Function Calling åŸºæœ¬æµç¨‹
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šæ·±å…¥æµå¼å¤„ç†å’Œå·¥å…·è°ƒç”¨çš„ç»†èŠ‚
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šå­¦ä¹  Skills ç³»ç»Ÿçš„æ¨¡å—åŒ–è®¾è®¡
4. **ç¬¬å››é˜¶æ®µ**ï¼šæŒæ¡é”™è¯¯å¤„ç†å’Œç»“æœè¿‡æ»¤çš„æœ€ä½³å®è·µ