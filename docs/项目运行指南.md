# Research Agent 项目运行指南

本文档提供 Research Agent 项目在本地开发环境与阿里云 PAI-EAS 环境下的完整运行、配置与部署指引。

---

## 1. 环境准备

### 1.1 系统要求
- **操作系统**：Windows / macOS / Linux
- **Python 版本**：Python 3.10+
- **网络**：需能够访问阿里云 DashScope API 及搜索服务（SerpAPI/Bing）

### 1.2 依赖安装
在项目根目录下运行以下命令安装所需 Python 库：

```bash
pip install -r requirements.txt
```

> **依赖清单说明**：
> - `fastapi`, `uvicorn`: Web 服务框架
> - `openai`: 调用阿里云百炼（DashScope）模型服务
> - `pydantic`: 数据验证与 Schema 定义
> - `PyYAML`: 解析 Skills 配置文件

---

## 2. 配置与启动

### 2.1 环境变量配置
项目使用 `.env` 文件管理密钥。请复制示例文件并填入你的 API Key：

1. 复制配置文件：
   ```bash
   # Windows
   copy .env.example .env
   # Linux/macOS
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填入以下内容：
   ```ini
   # 阿里云百炼 API Key (必需)
   DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx

   # 搜索服务密钥 (二选一，推荐 SerpAPI)
   SERPAPI_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxx
   # BING_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxx
   ```

### 2.2 启动本地服务
运行以下命令启动 Agent 服务：

```bash
python agent.py
```

服务启动后将监听 `http://localhost:8000`，提供以下接口：
- `POST /`: 普通问答接口（等待完整生成后返回）
- `POST /stream`: 流式问答接口（SSE 实时返回）
- `POST /ag-ui`: AG-UI 协议接口（用于调试面板）

### 2.3 验证服务可用性
你可以使用 `curl` 或 Postman 测试服务：

```bash
curl -X POST "http://localhost:8000/" \
     -H "Content-Type: application/json" \
     -d "{\"question\": \"北京今天的天气如何？\"}"
```

---

## 3. 批量验证与评测

项目内置了批量处理脚本 `run_batch.py`，用于对 `question.jsonl` 中的问题集进行自动化评测。

### 3.1 运行批处理
```bash
python run_batch.py
```

### 3.2 输出文件
- **submission.jsonl**: 生成的答案文件，格式为 `{"id": 0, "answer": "..."}`。
- **batch_run.log**: 详细运行日志，包含每个问题的耗时、重试情况及最终统计信息。

### 3.3 统计指标
脚本运行结束后，日志末尾会输出统计摘要，例如：
```
done count=50 ok=48 empty=0 timeout=1 error=1 dur=120.5s
```
- `ok`: 成功生成答案的数量
- `empty`: 生成了空答案的数量
- `timeout`: 超时数量
- `error`: 发生异常的数量

---

## 4. 部署到 PAI-EAS

### 4.1 打包项目
在 LangStudio 或本地环境中，将整个项目目录打包为 ZIP 文件。
**注意**：必须包含 `agent.py`, `agent_loop.py`, `skills/` 目录及 `requirements.txt`。

### 4.2 创建 EAS 服务
1. 登录阿里云 PAI 控制台，进入 **EAS 模型在线服务**。
2. 点击 **部署服务**，选择 **自定义部署**。
3. **模型文件**：上传你的 ZIP 包。
4. **运行环境**：选择 Python 3.10 基础镜像。
5. **启动命令**：
   ```bash
   python agent.py
   ```
   或者使用 uvicorn（生产环境推荐）：
   ```bash
   uvicorn agent:app --host 0.0.0.0 --port 8000
   ```
6. **端口配置**：设置服务端口为 `8000`。

### 4.3 环境变量配置
在服务配置页面的 **环境变量** 区域，添加以下键值对：
- `DASHSCOPE_API_KEY`: 你的 DashScope Key
- `SERPAPI_API_KEY` 或 `BING_API_KEY`: 你的搜索服务 Key

### 4.4 验证部署
部署成功后，点击服务详情获取 **公网访问地址 (Endpoint)** 和 **Token**。

使用 curl 验证：
```bash
curl -X POST "<Endpoint>" \
     -H "Authorization: Bearer <Token>" \
     -H "Content-Type: application/json" \
     -d "{\"question\": \"测试部署是否成功\"}"
```

---

## 5. 进阶功能说明

### 5.1 Deep Research 模式
项目集成了 `deep-research` 技能，当遇到复杂问题时，Agent 会自动执行以下流程：
1. **Initial Search**: 初步搜索获取概览。
2. **Web Fetch**: 针对高质量来源 URL 抓取全文内容。
3. **Evidence Extraction**: 从正文中提取精确事实。
4. **Synthesis**: 综合多源信息生成回答。

### 5.2 监控与日志
- **工具调用监控**：所有 `web_search` 和 `web_fetch` 的调用参数及异常都会打印到控制台（标准输出），在 EAS 日志页签中可直接查看。
- **API 配额检查**：服务启动及调用时会自动检查 API Key 是否配置，未配置时会返回明确的 JSON 错误信息。
