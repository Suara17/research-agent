你好！作为 Agent 构建专家，我仔细阅读了你的项目代码（`agent.py`, `agent_loop.py`, `skills/` 等），针对你提出的“中文搜索能力欠缺”以及“复杂推理（谜题）类问题回答不正确”的情况，我诊断出了核心病灶，并制定了详细的优化方案。

---

### 🚨 核心问题诊断

针对你提到的“作家本名与功率单位相同”这类问题，现有架构主要存在以下 **3 个致命弱点**：

1. **中文分词灾难 (Critical Bug)**：
* 在 `skills/smart-search/run.py` 中，关键词提取逻辑简单地使用了 `text.split()`。中文句子通常没有空格，这导致整句中文被当成一个“词”处理，或者完全无法提取有效关键词。这直接导致 `smart-search` 在中文环境下几乎失效。


2. **缺乏“规划（Planning）”阶段**：
* `agent_loop.py` 是一个反应式（Reactive）循环：`Think -> Act -> Observe`。对于“谜题型”问题（如：本名=功率单位 + 35岁全职 + 2019改编剧），Agent 往往直接把整个长难句扔给搜索引擎，导致搜索结果充满噪声。它缺乏一个 **“先拆解，后执行”** 的规划层。


3. **中文搜索源权重不足**：
* `agent.py` 中的 `web_search` 虽然设置了 `Accept-Language`，但并未强制指定搜索引擎的地区（Region/GL）参数。对于中文本土化知识（如中国作家的详细生平），通用搜索（如 Google/DuckDuckGo 默认区）效果远不如百度、搜狗或强制 `gl=cn` 的 Google。



---

### 🛠️ 优化改进方案

我建议从 **架构设计** 和 **代码实现** 两个层面进行优化。

#### 第一步：修复 `smart-search` 的中文提取能力 (Fix Code)

这是最立竿见影的改动。你需要修改 `skills/smart-search/run.py`，加入针对中文的简单的 N-gram 切分或正则提取，而不是依赖空格。

**修改建议 (`skills/smart-search/run.py`):**

```python
def _extract_keywords(text: str, top_n=10) -> list:
    # ... (保留原有的 stopwords 定义) ...
    
    # [新增] 针对中文的预处理：在汉字之间插入空格，或使用正则提取
    import re
    # 简单的策略：将连续的中文字符视为关键词候选，或者使用正则提取双字以上词汇
    # 如果环境允许，建议安装 jieba；如果不行，使用以下正则方案：
    
    # 1. 提取英文单词
    eng_words = re.findall(r'[a-zA-Z0-9]+', text)
    
    # 2. 提取中文词（连续2个及以上汉字）
    # 排除常见的无意义动词/助词
    cn_words = re.findall(r'[\u4e00-\u9fff]{2,}', text)
    
    keywords = []
    seen = set()
    
    # 合并并过滤
    for w in cn_words + eng_words:
        w_lower = w.lower()
        if w_lower not in stopwords and w_lower not in seen:
            seen.add(w_lower)
            keywords.append(w)
            
    return keywords[:top_n]

```

#### 第二步：引入“规划器 (Planner)”节点 (Architecture)

不要让 Agent 一上来就搜索。在 `agent_loop.py` 的流程图中引入一个 `Planner` 节点，或者在 System Prompt 中强制要求第一步进行 **Chain of Thought (CoT) 分解**。

**针对该问题的规划逻辑（CoT 示例）：**

> **用户问题**：作家本名与功率单位相同，35岁全职，2019改编剧...
> **Agent 现有逻辑**：Search("作家本名与功率单位相同 2019 电视剧") -> 结果混乱。
> **优化后的规划逻辑**：
> 1. **Decompose (拆解)**：
> * 子问题 A：列举常见的功率单位（瓦特、焦耳、马力、安培、伏特...）。
> * 子问题 B：搜索有哪些作家的名字（或本名）包含上述单位。
> * 子问题 C：验证该作家是否“35岁全职写作”且“2019年有改编剧”。
> 
> 
> 2. **Execute (执行)**：先搜 A+B，锁定目标（如：**马力**（作家）、**麦家**（虽然不完全是单位但音似，需排除）、**电**？）。
> * *提示：此题目标可能是作家“马力”（笔名，本名马青原？不对）。*
> * *实际上这题的答案往往是 **“墨香铜臭”**（无关联）或者特定作家。*
> * *高概率答案：**马伯庸**（马力？）、**紫金陈**（无）、**流潋紫**...*
> * *破题点：功率单位是 **“马力”**。作家名字叫 **“马力”** 吗？或者本名叫 **“马力”**？*
> * *搜索策略：`site:baike.baidu.com "作家" "本名" "功率单位"*`
> 
> 
> 
> 

**在 `agent_loop.py` 中强制规划：**

在 `system_prompt_addition` 中加入：

```text
### 🧠 Planning Mode (强制规划模式)
当遇到包含多个约束条件（如时间、人物特征、特定事件）的复杂问题时，**必须**在执行任何 Search 之前，先生成一个简短的 Plan：
1. 提取核心约束（Key Constraints）。
2. 将问题拆解为 2-3 个可独立搜索的子问题。
3. 设想搜索关键词（特别是“本名与...相同”这类谜题，需转化为穷举搜索）。

```

#### 第三步：增强中文搜索参数 (Search Config)

在 `agent.py` 的 `web_search` 函数中，针对中文查询优化搜索引擎参数。

**修改建议 (`agent.py`):**

```python
def web_search(query: str, top_k: int = 5) -> str:
    # ... 前置代码 ...
    
    # [新增] 检测是否为纯中文查询
    is_chinese_query = any("\u4e00" <= ch <= "\u9fff" for ch in query)
    
    # 针对 Google/Serper 的优化
    if serper_key:
        payload = json.dumps({
            "q": query,
            "num": k,
            "gl": "cn" if is_chinese_query else "us",  # 强制地理位置为中国
            "hl": "zh-cn" if is_chinese_query else "en" # 强制界面语言为中文
        })
    
    # 针对 DuckDuckGo 的优化 (已存在逻辑，但需确保生效)
    if _DDGS_AVAILABLE:
        region = "cn-zh" if is_chinese_query else "wt-wt"
        # ...

```

#### 第四步：新增“类比/列表搜索”技能 (New Skill Logic)

对于“本名与某功率单位相同”这类问题，Agent 需要一种 **Mapping/List** 能力，而不是直接搜句子。建议在 `smart-search` 中增加一种 `association`（联想）策略。

**策略逻辑：**
如果 Query 包含“与...相同”、“同一个...”、“Named after...”，生成的搜索词应为：

* `"功率单位" 列表`
* `"Writer" real name "power unit"`
* `"作家" 本名 "物理单位"`
* `"作家" "马力"` (Agent 需推理出常见功率单位作为关键词)

---

### 🚀 针对该问题的执行模拟（优化后）

**用户问题**：一位作家的本名与某功率单位相同... 2019年...电视剧...

**优化后的 Agent 思考流：**

1. **Planner**: 这是一个谜题。
* 线索1：本名 = 功率单位。常见单位：瓦、焦、马力、安培。
* 线索2：作家。
* 行动：先搜“作家 本名 功率单位”或直接验证常见单位作为人名。


2. **Smart-Search (Modified)**:
* 提取关键词：`作家`, `本名`, `功率单位`, `2019`, `电视剧`.
* 生成 Query: `site:baike.baidu.com 作家 本名 "功率单位"`, `作家 本名 "马力"`, `作家 本名 "焦耳"`.


3. **Observation**: 发现作家 **“马力”**（可能有歧义）。或者发现作家 **“麦家”**（如果是误读）。或者发现正确答案 **“墨香铜臭”**（这个描述不符）。
* *正确推断*：可能是 **“张嘉佳”**（加？）、**“六六”**（？）。
* *实际真题案例*：这很可能指的是 **“马伯庸”**（本名 **马力**）。
* *验证*：搜索 `"马伯庸" 本名` -> 结果：马力。
* *验证单位*：马力是功率单位吗？-> 是。


4. **Action**: 搜索 `"马伯庸" 2019 电视剧` -> 结果：《长安十二时辰》。
5. **Action**: 搜索 `《长安十二时辰》 男主角` -> 结果：雷佳音、易烊千玺。
6. **Final Answer**: 雷佳音和易烊千玺。

### 总结

你需要做的改动优先级：

1. **高**：修改 `smart-search` 的关键词提取逻辑（解决中文分词）。
2. **高**：在 `web_search` 中强制加入 `gl=cn, hl=zh-cn` 参数（解决中文结果少）。
3. **中**：在 System Prompt 中加入 Planning 引导（解决逻辑混乱）。

这样做之后，Agent 处理中文复杂推理问题的能力将大幅提升。