下面给出一个贴合当前代码与文档的 Research Agent 开发计划，覆盖目标、里程碑、实施清单与交付物标准，确保满足天池赛题在 PAI-LangStudio/EAS 的赛制约束。

**开发目标**
- 构建可部署到 EAS 的 Research Agent，支持 ReAct 推理-工具调用循环，输出纯文本答案。
- 集成搜索工具与技能系统，形成可观测、可调试的端到端服务。
- 完成本地批量验证并交付 LangStudio 项目包与 EAS 服务。

**现有基础**
- 服务入口与接口：
  - 普通与流式接口在 [agent.py](file:///e:/Research_Agent/agent.py#L46-L126) 已实现
  - AG-UI 事件流在 [agent.py](file:///e:/Research_Agent/agent.py#L129-L148) 与 [agui.py](file:///e:/Research_Agent/agui.py) 完成
- Agent Loop 与技能注入：
  - DashScope 兼容 OpenAI SDK 调用、流式片段处理、工具调用在 [agent_loop.py](file:///e:/Research_Agent/agent_loop.py#L115-L167) 与主循环 [agent_loop.py](file:///e:/Research_Agent/agent_loop.py#L168-L293)
  - 技能发现/系统提示/脚本执行在 [skills.py](file:///e:/Research_Agent/skills.py#L181-L260)
- 赛制与交付规范：
  - 红线约束、交付物说明见 [DEVELOPMENT_GUIDE.md](file:///e:/Research_Agent/DEVELOPMENT_GUIDE.md)
 
**当前进度综述**
- 里程碑 A（环境与最小可运行）：已完成。
- 里程碑 B（搜索工具与闭环）：已完成。
- 里程碑 C（提示词与策略）：已完成。系统提示词已全面优化，明确了 ReAct 模式、纯文本输出、语言一致性与幻觉拒绝。
- 里程碑 D（批量验证与质量）：已完成。run_batch.py 实现了重试、超时、速率控制与日志统计，可生成 batch_run.log。
- 里程碑 E（LangStudio/EAS）：准备就绪。README 已更新详细的部署说明，requirements.txt 完备，可随时打包。
- 里程碑 F（赛制合规与稳定）：已完成。web_search 增加了配额检查与监控日志；代码遵循无微调/无硬编码原则。

**实施进度快照**
- 环境与依赖：全部就位。
- 工具实现与注册：已完成。
- Agent Loop 与技能系统：已完成。
- 提示词与输出规范：已完成优化。
- 批处理与校验：已完成增强。
- 部署与一致性验证：文档已就绪，待实际部署。
- 合规与稳定：监控与回退策略已实现。

**下一步**
- 实际进行 LangStudio 打包与 EAS 部署。
- 在真实 EAS 环境中回归验证。

**分阶段里程碑**
- 里程碑 A：环境与最小可运行
  - 配置 DASHSCOPE_API_KEY，跑通本地 /、/stream、/ag-ui 接口
  - 熟悉 Agent Loop 输出与事件流，确保基础链路畅通
- 里程碑 B：搜索工具集成与 ReAct 闭环
  - 在 agent.py 注册实际可用的搜索工具函数（SerpAPI/IQS/Bing HTTP）
  - 在 agent_loop 中以工具 schema 暴露搜索功能，形成“思考→行动→观察→继续”闭环
- 里程碑 C：提示词与策略优化
  - 注入技能系统提示，约束工具使用时机与输出格式
  - 优化系统/助手提示词，减少幻觉与提升检索-抽取质量
- 里程碑 D：批量验证与质量保障
  - 编写本地批处理脚本，读取 [question.jsonl](file:///e:/Research_Agent/question.jsonl) 并调用本地接口生成答案
  - 加入基础校验（空答、时长、错误重试、速率控制），统计运行质量
- 里程碑 E：LangStudio/EAS 打包与部署
  - 在 LangStudio 创建应用流（工作流或代码模式），导出 ZIP 项目包
  - 部署到 EAS，获取 Endpoint/Token，并回归验证接口一致性
- 里程碑 F：赛制合规与稳定性
  - 核查不微调、不硬编码、不调用第三方 Agent 服务
  - 记录错误处理、日志观测、重试策略、超时控制，确保赛时稳定

**实施清单**
- 环境与依赖
  - 设置环境变量 DASHSCOPE_API_KEY（参考 [.env.example](file:///e:/Research_Agent/.env.example)）
  - 补齐依赖清单与启动说明（FastAPI、OpenAI SDK、ag_ui、可选 requests/HTTP 客户端）
- 工具实现与注册
  - 在 [agent.py](file:///e:/Research_Agent/agent.py) 实现并注册搜索工具函数（例如 search_web(query: str, top_k: int) -> str），包含类型提示与 Docstring
  - 将搜索工具传入 agent_loop 的 tool_functions，构建工具 schema（见 [agent_loop.py:function_to_schema](file:///e:/Research_Agent/agent_loop.py#L64-L97)）
- Agent Loop 与技能系统
  - 保持技能发现与系统提示注入（见 [skills.py:build_skills_system_prompt](file:///e:/Research_Agent/skills.py#L145-L178)）
  - 限制技能加载与脚本执行的安全边界（仅技能目录内文件与脚本；已有路径防逃逸逻辑）
- 提示词与输出规范
  - 系统提示词明确角色与工具调用规则，答案必须为纯文本且与提问语言一致（参考 [DEVELOPMENT_GUIDE.md](file:///e:/Research_Agent/DEVELOPMENT_GUIDE.md) 与 README 接口规范）
  - 针对复杂问题引导多步搜索与证据抽取，避免直接生成未经验证的结论
- 批处理与校验
  - 编写批量脚本：读取 question.jsonl，调用本地 / 接口，生成 submission.jsonl（每行 {"id": x, "answer": "..."}）
  - 增加基础质量校验与日志：
    - 空答/异常重试（有限次数）
    - 请求耗时统计与超时中断
    - 速率限制与错误记录
- 部署与一致性验证
  - 在 LangStudio 创建/导出 ZIP，部署到 EAS
  - 验证 EAS 与本地逻辑一致（接口路径、返回格式、技能/工具行为）
- 合规与稳定
  - 不微调、不硬编码、不外呼第三方 Agent 服务
  - 搜索引擎 API Key 管理与配额监控
  - 异常恢复、流式输出健壮性与内存占用控制
 
**实施进度快照**
- 环境与依赖：环境变量已就位；依赖清单与启动说明已补齐。
- 工具实现与注册：已完成 web_search 注册与工具 schema 暴露。
- Agent Loop 与技能系统：技能发现与系统提示注入已完成；安全边界在技能工具中实现。
- 提示词与输出规范：进行中。已约束输出为纯文本与一致语言；复杂问题的检索-抽取引导需加强。
- 批处理与校验：部分完成。已加入重试/超时/速率与日志统计；后续完善指标与异常分类。
- 部署与一致性验证：未开始。
- 合规与稳定：进行中。错误处理与 SSE 健壮性已覆盖；API Key 配额监控与告警待加。
 
**下一步优先事项**
- 补齐依赖清单与 README 启动说明，明确本地与 EAS 环境差异。
- 完成批处理质量校验与日志（空答重试、超时、速率、统计）。
- 优化系统提示与工具使用策略，降低幻觉、提升检索-抽取质量。
- 准备 LangStudio 项目打包与 EAS 部署流程，完成一致性回归。
- 引入搜索 API 配额监控与异常回退策略，保障赛时稳定。

**关键设计要点与代码走读**
- Agent Loop 结构
  - 流式增量片段 → 累积工具调用参数 → 执行工具 → 以 tool 角色回填 → 继续对话循环（见 [agent_loop.py](file:///e:/Research_Agent/agent_loop.py#L168-L293)）
- 工具 Schema 构造与映射
  - 由函数签名生成 JSON Schema，自动暴露到 LLM 的 tool 调用（见 [function_to_schema](file:///e:/Research_Agent/agent_loop.py#L64-L97)）
  - 名称到函数的映射与异步/同步执行处理（见 [agent_loop.py](file:///e:/Research_Agent/agent_loop.py#L258-L265)）
- 技能系统注入与安全
  - 自动发现技能、将技能描述注入系统提示；限制脚本执行目录与超时（见 [skills.py](file:///e:/Research_Agent/skills.py#L181-L260)）
- 接口与事件流
  - 普通/流式接口编排与分段输出（见 [agent.py](file:///e:/Research_Agent/agent.py#L46-L126)）
  - AG-UI 事件转换与 SSE 数据封装（见 [agui.py](file:///e:/Research_Agent/agui.py#L63-L137)、[agui.py:to_sse_data](file:///e:/Research_Agent/agui.py#L140-L150)）

**交付物与验收标准**
- 阶段一（截止 2026-03-09）
  - 本地运行通过；能对 question.jsonl 批量生成 submission.jsonl，格式为 {"id": x, "answer": "纯文本"}
- 阶段二（截止 2026-03-09）
  - EAS Endpoint + Bearer Token
  - LangStudio 项目包 ZIP（含 README/架构与依赖说明、复现步骤）
  - 服务逻辑与 ZIP 一致性核验通过

**风险与缓解**
- 搜索结果噪声大
  - 提示词明确检索目标，提取结构化要点；必要时多源交叉
- 工具调用失败或超时
  - 超时与重试策略、回退到直接回答但标注不确定
- 模型速率与配额
  - 请求节流、并发控制、统计调用量
- SSE 与事件流稳定性
  - 异常保护与消息闭合，防止流挂起

**默认假设**
- 搜索工具优先采用 SerpAPI 或阿里云 IQS 的 HTTP 接口；若需更换为 Bing API，保持“仅工具而非 Agent 服务”的赛制约束。
- 依赖安装与打包在 LangStudio 侧可按 README 引导完成；如需新增依赖，将在项目包内声明并经平台构建测试。
